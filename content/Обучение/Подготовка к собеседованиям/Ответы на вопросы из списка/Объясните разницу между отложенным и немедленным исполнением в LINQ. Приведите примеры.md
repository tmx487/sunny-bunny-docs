---
уровень: "[[middle]]"
секция: платформа .NET
пройдено: 
теги: 
дата: 02-05-2024
время: 20:27
---
В LINQ (Language Integrated Query) существует два основных типа исполнения запросов: отложенное (deferred) и немедленное (eager) исполнение. Понимание этих двух концепций важно для правильного использования LINQ и оптимизации производительности запросов.

### Отложенное исполнение (Deferred Execution)

**Отложенное исполнение** означает, что выполнение запроса не происходит до тех пор, пока не будет действительно необходимо. Это позволяет формировать запросы, комбинировать их и выполнять только тогда, когда к результатам запроса потребуется доступ. 

Когда используется отложенное исполнение, LINQ выражение просто создает план выполнения запроса, который будет оценен при фактическом выполнении запроса. Это означает, что любые **изменения** в данных, которые происходят **между** созданием запроса и его выполнением, **будут учтены**.

#### Пример:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

class Program
{
    static void Main()
    {
        List<int> numbers = new List<int> { 1, 2, 3, 4, 5 };
        var query = numbers.Where(n => n > 2);

        Console.WriteLine("Query is created but not executed yet.");

        foreach (var number in query)
        {
            Console.WriteLine(number);
        }
    }
}
```

**Объяснение:**
- В данном примере `query` является запросом с отложенным исполнением. Запрос не выполняется при его создании.
- Запрос будет выполнен только при итерации по `query` в цикле `foreach`.
- Если список `numbers` изменится между созданием запроса и его выполнением, изменения будут учтены.

### Немедленное исполнение (Eager Execution)

**Немедленное исполнение** означает, что результат запроса вычисляется немедленно при создании запроса. Это часто используется с методами, которые требуют оценки результата, такими как `ToList()`, `ToArray()`, `First()`, `Single()`, и т. д.

Когда используется немедленное исполнение, данные запрашиваются и сохраняются в коллекции или в переменной сразу, и любые последующие изменения в источнике данных не будут отражены в уже полученных данных.

#### Пример:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

class Program
{
    static void Main()
    {
        List<int> numbers = new List<int> { 1, 2, 3, 4, 5 };
        var query = numbers.Where(n => n > 2).ToList();

        Console.WriteLine("Query is executed immediately and results are stored in a list.");

        // Add more numbers to the list after query execution
        numbers.Add(6);
        numbers.Add(7);

        foreach (var number in query)
        {
            Console.WriteLine(number); // Output will not include the newly added numbers (6 and 7)
        }
    }
}
```

**Объяснение:**
- В данном примере `query` использует метод `ToList()`, который вызывает немедленное исполнение запроса.
- Результаты запроса сохраняются в списке, и любые изменения в источнике данных после выполнения запроса не будут отражены в `query`.

### Итоги и советы

- **Отложенное исполнение** полезно, когда вы хотите отложить выполнение запроса до момента, когда результаты действительно понадобятся, и когда необходимо учитывать изменения в данных.
- **Немедленное исполнение** полезно, когда вы хотите получить результат сразу и работать с ним, а также предотвратить влияние изменений в исходных данных после выполнения запроса.

Выбор между отложенным и немедленным исполнением зависит от конкретных потребностей вашего приложения и сценария использования данных.