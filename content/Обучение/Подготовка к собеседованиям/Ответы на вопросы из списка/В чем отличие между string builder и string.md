---
уровень: "[[junior]]"
секция: типы, структуры и коллекции данных
пройдено: 
теги: 
дата: 02-05-2024
время: 19:52
---
> Если в приложении строки сравниваются часто методом порядкового сравнения [^1] с учетом регистра или если в приложении ожидается появление множества одинаковых строковых объектов, то для повышения производительности надо применить поддерживаемый CLR механизм **интернирования строк**[^2] (*string interning*). При инициализации CLR создает внутреннюю хеш-таблицу[^3], в которой ключами являются строки, а значениями — ссылки на строковые объекты в управляемой куче. Вначале таблица, разумеется, пуста. В классе String есть два метода, предоставляющие доступ к внутренней хеш-таблице:
> ```c#
> 	public static String Intern(String str);
> 	public static String IsInterned(String str);
> ```

[[Библиотека/Книги/Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013.pdf#page=369&selection=95,0,115,44|Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013, страница 369]]

[^1]: При **порядковом сравнении** (*ordinal comparison*) CLR быстро проверяет, равно ли количество символов в строках. При отрицательном результате строки точно не равны, но если длина одинакова, приходится сравнивать их символ за символом. При сравнении с учетом региональных стандартов среде CLR тоже приходится посимвольно сравнить строки, потому что две строки разной длины могут оказаться равными
[^2]: _Интернирование строк_ — это механизм, при котором одинаковые литералы представляют собой один объект в памяти [[Особенности строк в .NET _ Хабр.pdf#page=8&selection=0,0,4,40|Особенности строк в .NET _ Хабр, страница 8]]
[^3]: Обратите внимание, что уборщик мусора не вправе освободить строки, на которые ссылается внутренняя хеш-таблица, поскольку в ней самой есть ссылки на эти String. Объекты String, на которые ссылается внутренняя хеш-таблица, нельзя освободить, пока не выгружен соответствующий домен приложения или не закрыт поток.

> Тип **String** представляет собой неизменяемую строку, а для динамических операций со строками и символами при создании объектов String в FCL имеется тип **System.Text.StringBuilder**.

[[Библиотека/Книги/Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013.pdf#page=375&selection=115,0,128,1|Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013, страница 375]]

> При увеличении строки, представляющей ранее выделенный массив символов, **StringBuilder** автоматически выделит память для нового, большего по размеру массива, скопирует символы и приступит к работе с новым массивом. А прежний массив попадет в сферу действия уборщика мусора.

[[Библиотека/Книги/Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013.pdf#page=376&selection=17,52,27,22|Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013, страница 376]]

> Сформировав свою строку с помощью объекта StringBuilder, «преобразуйте» массив символов StringBuilder в объект String, вызвав метод ToString типа StringBuilder. Этот метод просто возвращает ссылку на поле-строку, управляемую объектом StringBuilder. Поскольку массив символов здесь не копируется, метод выполняется очень быстро. Объект String, возвращаемый методом ToString, не может быть изменен. 

[[Библиотека/Книги/Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013.pdf#page=376&selection=28,0,58,20|Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013, страница 376]]

В .NET `StringBuilder` и `string` (строка) используются для работы с текстовыми данными, но они имеют разные характеристики и применяются в различных сценариях. Рассмотрим основные отличия между ними:

### `string`

1. **Иммутабельность**:
   - `string` является неизменяемым типом данных, что означает, что после создания строки ее значение нельзя изменить. Любые операции, которые изменяют строку, создают новую строку.

2. **Производительность**:
   - Из-за иммутабельности, частое изменение строк (например, конкатенация в цикле) приводит к созданию множества временных объектов в памяти, что может снизить производительность и привести к излишним затратам на память и сборку мусора.

3. **Сценарии использования**:
   - Используется для работы с небольшими и неизменяемыми строками, когда количество операций изменения текста минимально.

4. **Пример использования**:
   ```csharp
   string greeting = "Hello";
   greeting += " World";
   ```

### `StringBuilder`

1. **Мутируемость**:
   - `StringBuilder` является изменяемым типом данных. Его содержимое можно изменять без создания новых объектов, что делает его более эффективным при частых изменениях строки.

2. **Производительность**:
   - Лучше подходит для сценариев, где требуется частое изменение строк, таких как конкатенация в цикле. `StringBuilder` динамически управляет своим внутренним буфером, что позволяет избегать излишних аллокаций памяти.

3. **Сценарии использования**:
   - Используется для работы с большими и часто изменяемыми строками, когда необходимо выполнять множество операций изменения текста.

4. **Пример использования**:
   ```csharp
   var builder = new StringBuilder();
   builder.Append("Hello");
   builder.Append(" World");
   string greeting = builder.ToString();
   ```

### Сравнение и рекомендации

- **Изменение строк**: Если необходимо изменить строку один или два раза, использование `string` вполне оправдано. Если же требуется множество изменений, `StringBuilder` будет более эффективным.
- **Память**: `StringBuilder` использует внутренний буфер для хранения данных, который увеличивается по мере необходимости. Это позволяет снизить количество операций выделения памяти.
- **Чтение и запись**: `string` обеспечивает простоту и удобство работы с неизменяемыми строками, тогда как `StringBuilder` обеспечивает эффективность при частых изменениях строк.

### Пример сравнения:

#### Использование `string` в цикле (неэффективно):
```csharp
string result = "";
for (int i = 0; i < 1000; i++)
{
    result += i.ToString() + " ";
}
```

#### Использование `StringBuilder` в цикле (эффективно):
```csharp
var builder = new StringBuilder();
for (int i = 0; i < 1000; i++)
{
    builder.Append(i.ToString()).Append(" ");
}
string result = builder.ToString();
```

### Заключение

- Используйте `string` для работы с неизменяемыми или редко изменяемыми строками.
- Используйте `StringBuilder` для работы с большими или часто изменяемыми строками, чтобы улучшить производительность и снизить затраты на память.

