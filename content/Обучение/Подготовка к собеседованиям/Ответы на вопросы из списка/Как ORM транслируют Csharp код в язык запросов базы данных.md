---
уровень: "[[middle]]"
секция: базы_данных
пройдено: 
теги: 
дата: 02-05-2024
время: 20:46
---
. Что для этого используется

ORM (Object-Relational Mapping), такие как Entity Framework и Entity Framework Core, используются для автоматической трансляции C# кода в язык запросов базы данных, такой как SQL. Основной механизм, который позволяет ORM выполнять эту трансляцию, называется **Expression Trees** (деревья выражений) и **LINQ** (Language Integrated Query). 

Вот основные этапы и компоненты этого процесса:

### 1. Использование LINQ для Запросов

ORM использует LINQ для построения запросов к базе данных. Когда вы пишете LINQ-запросы в C# коде, ORM преобразует их в SQL-запросы. Например, следующий LINQ-запрос:

```csharp
var users = context.Users
    .Where(u => u.IsActive)
    .OrderBy(u => u.Name)
    .ToList();
```

Будет преобразован ORM в SQL-запрос:

```sql
SELECT * FROM Users
WHERE IsActive = 1
ORDER BY Name;
```

### 2. Деревья Выражений (Expression Trees)

Деревья выражений — это мощный механизм в .NET, который позволяет представлять коды в виде объектов. Это позволяет ORM анализировать и интерпретировать запросы на этапе компиляции, а затем преобразовывать их в SQL-запросы.

Когда вы пишете LINQ-запросы, компилятор преобразует их в деревья выражений, которые затем передаются в ORM. ORM анализирует эти деревья выражений, чтобы построить соответствующий SQL-запрос.

### 3. Основные Этапы Трансляции

#### a. Сборка Деревьев Выражений

LINQ-запросы преобразуются в деревья выражений. Например, следующий код:

```csharp
Expression<Func<User, bool>> predicate = u => u.IsActive;
```

Создает дерево выражений, которое ORM может анализировать.

#### b. Интерпретация Деревьев Выражений

ORM анализирует дерево выражений для извлечения информации о том, какие операции нужно выполнить. Например, анализируя выражение `u => u.IsActive`, ORM понимает, что нужно создать SQL-фильтр по полю `IsActive`.

#### c. Генерация SQL

После того как ORM разобрал дерево выражений, оно преобразует его в SQL-запрос. В этом процессе ORM интерпретирует, как и какие данные необходимо извлечь, какие фильтры применить и как отсортировать результаты.

### 4. Пример Преобразования

Рассмотрим более подробный пример:

#### C# Код

```csharp
var query = context.Orders
    .Where(o => o.OrderDate >= DateTime.Now.AddDays(-30))
    .Select(o => new { o.OrderId, o.CustomerName });
```

#### Дерево Выражений

Это LINQ-запрос создаст дерево выражений, которое включает:

- Фильтр по `OrderDate`
- Проекцию (`Select`) с выборкой полей `OrderId` и `CustomerName`

#### SQL Запрос

ORM преобразует это в SQL-запрос:

```sql
SELECT OrderId, CustomerName
FROM Orders
WHERE OrderDate >= DATEADD(day, -30, GETDATE());
```

### 5. Используемые Компоненты в Entity Framework

- **`DbContext`**: Управляет соединением с базой данных и предоставляет доступ к коллекциям сущностей.
- **`DbSet<T>`**: Представляет коллекцию сущностей, с которыми можно выполнять CRUD-операции.
- **`EntityTypeConfiguration`**: Определяет конфигурацию сущностей, как они отображаются на таблицы в базе данных.
- **`QueryProvider`**: Отвечает за выполнение LINQ-запросов и их преобразование в SQL.

### Заключение

Entity Framework и Entity Framework Core используют деревья выражений и LINQ для преобразования C# кода в SQL-запросы. Этот процесс включает сборку и интерпретацию деревьев выражений, а затем генерацию соответствующего SQL-запроса. Такой подход упрощает работу с базой данных, позволяя разработчикам писать код на C#, который ORM автоматически преобразует в SQL.