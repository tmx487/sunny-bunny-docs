---
уровень: "[[junior]]"
секция: платформа .NET
пройдено: 
теги: 
дата: 02-05-2024
время: 19:44
---
> **Делегат** (функция обратного вызова) - переменная, содержащая указатели на метод или методы. Они обеспечивают возможность последовательного вызова нескольких методов, а также вызова как *статических*, так и *экземплярных* методов. Делегаты безопасны по отношению к типам

Результатом использования делегата будет результат работы метода. Делегаты поддерживают операции сложения/вычитания, напр., следующий код будет работать:

```csharp
public class MethodClass
{
    public void Method1(string message) { }
    public void Method2(string message) { }
}

var obj = new MethodClass();
Callback d1 = obj.Method1;
Callback d2 = obj.Method2;
Callback d3 = DelegateMethod;

// Both types of assignment are valid.
Callback allMethodsDelegate = d1 + d2;
allMethodsDelegate += d3;

//remove Method1
allMethodsDelegate -= d1;

// copy AllMethodsDelegate while removing d2
Callback oneMethodDelegate = allMethodsDelegate - d2;
```

В C# существуют следующие предопределенные делегаты (они могут принимать до 16 параметров):
- Func<> соответствуют методам, которые **возвращают** значения
- Action<> соответствуют методам, которые **не возвращают** значения

> Более подробно о [Action<>](#https://learn.microsoft.com/ru-ru/dotnet/api/system.action-1?view=net-8.0) и [Func<>](#https://learn.microsoft.com/en-us/dotnet/api/system.func-2?view=net-8.0)

```csharp
static void Main(string[] args)
{
	PerformOperationWithLogging(AddWithLogging, 50, 10);
}

static void AddWithLogging(int x, int y) => Console.WriteLine($"{x} + {y} = {x + y}");

static void PerformOperationWithLogging(Action<int, int> operatorWithLogging, int x, int y) => operatorWithLogging(x, y);
```

[Неплохо вспомнить](#https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/covariance-contravariance/) (ковариантность и контравариантность)

**Ковариантность** (covariance)[^1] означает, что метод может возвратить тип, производный от типа, возвращаемого делегатом. **Контравариантность**[^2] (contra-variance) означает, что метод может принимать параметр, который является базовым для типа параметра делегата. Например:

[^1]: [[Передача параметров в методы (in, out, ref)#2. `out` (Output)]]
[^2]: [[Передача параметров в методы (in, out, ref)#3. `in` (Input)]]

```csharp
delegate Object MyCallback(FileStream s);
```

Определив делегат таким образом, можно получить экземпляр этого делегата, связанный с методом, прототип которого выглядит примерно так:

```csharp
String SomeMethod(Stream s); //ковариантность т.к. String потомок Object
	                         //контравариантность т.к. Stream базовый для FileStream
```

> ==Ковариантность и контравариантность поддерживаются только для ссылочных типов==, но не для значимых типов или значения void. **Значимые типы и void не могут использоваться ковариантно и контравариантно, потому что их структура памяти меняется, в то время как для ссылочных типов структурой памяти в любом случае остается указатель**. К счастью, при попытке выполнить запрещенные действия компилятор возвращает сообщение об ошибке

[**Predicate**](#https://metanit.com/sharp/tutorial/3.33.php)

Делегат [Predicate<T\>](#https://learn.microsoft.com/en-us/dotnet/api/system.predicate-1?view=net-8.0) принимает один параметр и возвращает значение типа bool:

```csharp
delegate bool Predicate<in T>(T obj);
```

Как правило, используется для сравнения, сопоставления некоторого объекта T определенному условию. В качестве выходного результата возвращается значение true, если условие соблюдено, и false, если не соблюдено:

```csharp
Predicate<int> isPositive = (int x) => x > 0;
 
Console.WriteLine(isPositive(20));
Console.WriteLine(isPositive(-20));
```

В данном случае возвращается true или false в зависимости от того, больше нуля число или нет.