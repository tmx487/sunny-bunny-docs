---
уровень: "[[middle]]"
секция: базы_данных
пройдено: 
теги: 
дата: 02-05-2024
время: 20:46
---
План выполнения запроса (execution plan) в MS SQL Server — это план действий, который сервер базы данных использует для выполнения SQL-запроса. Он определяет, как будут извлекаться, фильтроваться и соединяться данные из базы данных для получения результата запроса. План выполнения помогает оптимизировать выполнение запроса, обеспечивая наилучшую производительность.

### Основные аспекты плана выполнения запроса

1. **Цель плана выполнения**:
   - Определить наиболее эффективный способ выполнения SQL-запроса с учетом структуры данных, индексов и статистики.

2. **Типы планов выполнения**:
   - **Фактический план выполнения (Actual Execution Plan)**: План, который отображает реальное выполнение запроса, включая время выполнения, количество обработанных строк и фактическое использование индексов.
   - **Ожидаемый план выполнения (Estimated Execution Plan)**: План, который SQL Server создает до выполнения запроса, используя статистику и предполагаемые затраты. Он показывает, как сервер планирует выполнить запрос, но не включает реальные данные о выполнении.

3. **Компоненты плана выполнения**:
   - **Операторы (Operators)**: Действия, которые выполняются для обработки данных. Например, сканирование таблицы (Table Scan), индексный поиск (Index Seek), соединение таблиц (Join).
   - **Структуры данных**: Таблицы, индексы и другие объекты базы данных, которые используются в запросе.
   - **Затраты (Costs)**: Оценочные затраты на выполнение каждого оператора в плане. Обычно выражаются в процентах от общего времени выполнения запроса.

4. **Как получить план выполнения**:
   - **В SQL Server Management Studio (SSMS)**:
     - **Фактический план выполнения**: Нажмите кнопку "Include Actual Execution Plan" на панели инструментов перед выполнением запроса или используйте сочетание клавиш `Ctrl + M`.
     - **Ожидаемый план выполнения**: Нажмите кнопку "Display Estimated Execution Plan" на панели инструментов перед выполнением запроса или используйте сочетание клавиш `Ctrl + L`.
   - **Использование SQL-команд**:
     - Для получения фактического плана выполнения можно использовать команду `SET STATISTICS XML ON;` перед выполнением запроса.
     - Для анализа планов выполнения в виде XML используйте команды `SET SHOWPLAN_XML ON;` для отображения ожидаемого плана.

5. **Примеры использования плана выполнения**:
   - **Оптимизация запросов**: Анализируйте план выполнения, чтобы определить, какие операторы занимают наибольшее количество времени, и измените запрос или структуру базы данных для улучшения производительности.
   - **Проверка использования индексов**: Убедитесь, что индексы используются эффективно и не происходят полные сканирования таблиц.

### Пример

Предположим, у вас есть следующий запрос:
```sql
SELECT * FROM Employees WHERE LastName = 'Smith';
```

Вы можете получить план выполнения для этого запроса в SSMS:

1. Включите отображение фактического плана выполнения, нажав кнопку "Include Actual Execution Plan".
2. Выполните запрос.

После выполнения вы увидите вкладку "Execution Plan" с графическим представлением плана выполнения. Он может содержать такие операторы, как `Index Seek` (если используется индекс на поле `LastName`) или `Table Scan` (если индекс не используется).

### Примеры операторов плана выполнения:

- **Table Scan**: Полное сканирование таблицы. Используется, если нет соответствующих индексов.
- **Index Seek**: Эффективный поиск данных с использованием индекса.
- **Hash Join**: Объединение двух таблиц с использованием хеширования для улучшения производительности соединений.

### Заключение

План выполнения запроса в MS SQL Server — это важный инструмент для понимания и оптимизации производительности SQL-запросов. Анализ плана выполнения помогает выявить узкие места и эффективно использовать ресурсы базы данных для достижения лучшего выполнения запросов.