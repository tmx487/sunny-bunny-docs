---
уровень: "[[junior]]"
секция: общее
пройдено: true
теги: 
дата: 02-05-2024
время: 19:25
---

> Прерывание потока или выгрузка домена приложений является источником исключения ThreadAbortException, обеспечивающего выполнение блока finally. **Если же поток прерывается функцией TerminateThread или методом FailFast класса System.Environment, блок finally не выполняется.** Разумеется, Windows производит очистку всех ресурсов, которые использовались прерванным процессом.
> \- [[Библиотека/Книги/Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013.pdf#page=501&selection=187,0,188,1|Рихтер Дж. - CLR via C#. Программирование на платформе Microsoft .NET Framework 4.5 на языке C#. 4-е изд. (Мастер-класс) - 2013, страница 501]]


Блок `finally` в C# почти всегда выполняется, даже если в блоках `try` или `catch` возникло исключение. Однако существуют редкие случаи, когда блок `finally` не будет выполнен:

1. **Программное завершение процесса**:
    - Если процесс, в котором выполняется код, принудительно завершается, например, с помощью вызова `Environment.FailFast()`, блок `finally` не будет выполнен. Этот метод сразу завершает процесс и пишет сообщение об ошибке в лог.

    ```csharp
    try
    {
        // Some code
    }
    finally
    {
        // This will not execute
        Environment.FailFast("Critical failure");
    }
    ```

2. **Сбой системы или аварийное завершение приложения**:
    - Если операционная система сталкивается с критической ошибкой, такой как аппаратный сбой, который приводит к аварийному завершению процесса, блок `finally` не будет выполнен.

3. **Проблемы с питанием**:
    - Если во время выполнения программы произойдет сбой питания или аппаратная перезагрузка, блок `finally` не будет выполнен.

4. **Бесконечный цикл внутри блока `finally`**:
    - Если внутри блока `finally` находится бесконечный цикл или код, который никогда не завершится, это фактически остановит выполнение программы, и следующий код никогда не будет выполнен.

    ```csharp
    try
    {
        // Some code
    }
    finally
    {
        while (true)
        {
            // Infinite loop
        }
    }
    ```

5. **Необработанное исключение в блоке `finally`**:
    - Если в блоке `finally` возникает необработанное исключение, выполнение блока будет прервано, и оставшаяся часть блока `finally` не будет выполнена.

    ```csharp
    try
    {
        // Some code
    }
    finally
    {
        // Some code
        throw new Exception("Error in finally");
        // Code here will not be executed
    }
    ```

Эти случаи довольно редки и связаны с особыми условиями, выходящими за рамки нормального выполнения программы. В обычной практике блок `finally` выполняется всегда, даже если в блоках `try` или `catch` возникает исключение.