---
уровень: "[[middle]]"
секция: типы, структуры и коллекции данных
пройдено: 
теги: 
дата: 02-05-2024
время: 20:31
---
**Immutable object** (неизменяемый объект) — это объект, состояние которого не может быть изменено после его создания. Как только объект создан, его поля и свойства становятся постоянными, и любые попытки изменить его состояние приводят к созданию нового объекта с измененными значениями, а не к изменению существующего.

### Преимущества использования неизменяемых объектов

1. **Безопасность потоков (Thread Safety)**:
   - Неизменяемые объекты являются естественным образом потокобезопасными, поскольку их состояние не может изменяться. Это делает их идеальными для многопоточных приложений, так как не требуется синхронизация доступа к ним.

2. **Упрощение кода**:
   - Использование неизменяемых объектов упрощает код, поскольку вы не нуждаетесь в сложных механизмах для отслеживания изменений состояния объектов. Легче понять и отладить код, когда вы знаете, что объект остается неизменным.

3. **Кэширование**:
   - Поскольку состояние неизменяемого объекта не меняется, его можно безопасно кэшировать и повторно использовать. Это может повысить производительность, особенно в случае часто используемых объектов.

4. **Снижение ошибок**:
   - Неизменяемые объекты помогают предотвратить ошибки, связанные с изменением состояния, так как изменения в одном месте не могут непреднамеренно повлиять на другие части программы.

5. **Легкость в тестировании**:
   - Неизменяемые объекты упрощают тестирование, так как тесты становятся более предсказуемыми и стабильными, поскольку объект не изменяется между вызовами.

### Реализация неизменяемого объекта в .NET

В C# можно реализовать неизменяемый объект, следуя нескольким принципам:

1. **Использование `readonly` полей**:
   - Определите все поля как `readonly`, чтобы гарантировать, что они могут быть установлены только в конструкторе.

2. **Отсутствие сеттеров**:
   - Не предоставляйте сеттеры для свойств, чтобы они могли быть изменены только в конструкторе.

3. **Конструктор**:
   - Убедитесь, что конструктор инициализирует все свойства, так как они не могут быть изменены после создания объекта.

### Пример реализации неизменяемого объекта

Вот пример простого неизменяемого объекта в C#:

```csharp
public class ImmutablePerson
{
    // Поля, доступные только для чтения
    public string FirstName { get; }
    public string LastName { get; }
    public int Age { get; }

    // Конструктор инициализирует все свойства
    public ImmutablePerson(string firstName, string lastName, int age)
    {
        FirstName = firstName;
        LastName = lastName;
        Age = age;
    }
}
```

### Дополнительные аспекты

1. **Immutable Collections**:
   - .NET предоставляет коллекции, которые являются неизменяемыми, такие как `ImmutableList<T>`, `ImmutableDictionary<TKey, TValue>`, и другие, через библиотеку `System.Collections.Immutable`.

2. **Record Types**:
   - В C# 9.0 и выше введен тип данных `record`, который по умолчанию является неизменяемым. Запись автоматически реализует `IEquatable<T>`, что упрощает работу с неизменяемыми объектами.

   Пример использования `record`:

   ```csharp
   public record Person(string FirstName, string LastName, int Age);
   ```

   Записи обеспечивают неизменяемость, а также имеют встроенную поддержку для сравнения значений и клонирования.

### Заключение

Неизменяемые объекты — это важный инструмент для создания надежных и потокобезопасных приложений. Они упрощают разработку и поддержку кода, предотвращают множество классов ошибок и улучшают производительность. В .NET неизменяемые объекты можно создавать с помощью `readonly` полей, конструктора и `record` типов.