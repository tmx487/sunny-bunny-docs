## üìî–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### üìë–ß—Ç–æ —Ç–∞–∫–æ–µ Middleware?

–≠—Ç–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞ –≤ `request pipeline` (–∫–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤), –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤.

### üìë–ö–∞–∫–∏–µ Middleware —Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª?

`UseHttpsRedirection(), UseCors(), UseAuthentication(), UseAuthorization(), UseSerilogRequestLogging(), UseSwagger(), UseSwaggerUI(), UseExceptionHandler("/error")`

### üìë–ö–∞–∫–∏–µ Middleware —Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª? –î–ª—è —á–µ–≥–æ?

UseCors(), —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ API –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
UseSwagger() - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Swagger
UseExceptionHandler() - –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –≤—ã–ª–µ—Ç–∞–ª–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—à–∏–±–∫–æ–π (–≤ Error-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –¥–ª—è —ç—Ç–æ–≥–æ –±—ã–ª –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø—Ä–æ–∏–Ω—Ç)

–¢–∞–∫–∂–µ –¥–µ–ª–∞–ª–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π `middleware` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–ª—é—Å –¥–æ–±–∞–≤–∏–ª–∞ –∫ –Ω–µ–º—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å `Grafana` –∏ `Prometheus`, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–±–∏—Ä–∞—Ç—å –ª–æ–≥–∏, –∏–∑–º–µ—Ä—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –¥–µ–ª–∞—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤.

### üìë–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤¬†[ASP.NET](http://asp.net/)¬†–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —Ç—ã –∑–Ω–∞–µ—à—å?

- **–≥–ª–æ–±–∞–ª—å–Ω–æ** –ø—É—Ç–µ–º —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ `middleware`

- **–∞—Ç—Ä–∏–±—É—Ç—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**

```csharp
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
services.AddControllers(options => {
    options.Filters.Add(new HttpResponseExceptionFilter());
});

// –ò–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
[ApiController]
[ServiceFilter(typeof(CustomExceptionFilter))]
public class ProductsController : ControllerBase 
{
    // –ú–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
}

// –ò–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç–∫—à–µ–Ω–∞
[HttpGet]
[ServiceFilter(typeof(CustomExceptionFilter))]
public IActionResult Get() 
{
    // –õ–æ–≥–∏–∫–∞ –º–µ—Ç–æ–¥–∞
}
```

- —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏—Å–∫–ª—é—á–µ–Ω–∏–π**

```csharp
public class CustomExceptionFilter : IExceptionFilter
{
    private readonly ILogger<CustomExceptionFilter> _logger;
    
    public CustomExceptionFilter(ILogger<CustomExceptionFilter> logger)
    {
        _logger = logger;
    }
    
    public void OnException(ExceptionContext context)
    {
        _logger.LogError(context.Exception, "–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ");
        
        var result = new ObjectResult(new {
            error = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞",
            statusCode = StatusCodes.Status500InternalServerError
        }) 
        {
            StatusCode = StatusCodes.Status500InternalServerError
        };
        
        context.Result = result;
        context.ExceptionHandled = true;
    }
}
```

- `try/catch` + —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π

- **Problem Details** –¥–ª—è REST API (RFC 7807)

- —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ `Result`

### üìë–î–ª—è —á–µ–≥–æ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã? –í —á—ë–º –±—É–¥–µ—Ç —Ä–∞–∑–Ω–∏—Ü–∞, –µ—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ?

| async –º–µ—Ç–æ–¥                                                                                                                        | sync –º–µ—Ç–æ–¥                                                                                                    |
| ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| –¥–∞–µ—Ç —Ö–æ—Ä–æ—à—É—é –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, —Ç.–∫. –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç –ø–æ—Ç–æ–∫–∏, –ø–æ—ç—Ç–æ–º—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ | –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫–∏ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—ç—Ç–æ–º—É –Ω–∏–∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≥–∏–±–∫–æ—Å—Ç—å |
## üìîASP.NET ¬∑ –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### üìë–ß—Ç–æ —Ç–∞–∫–æ–µ DI (Dependency Injection)?

–ü–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –∏ –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∏–±–∫–∏–µ –∏ –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã, —Å–Ω–∏–∂–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É–ª—É—á—à–∞—è –∏—Ö —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å.

–û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã `DI`:
	- **–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - —ç—Ç–æ –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
	- **–∏–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
	- **–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`DI` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)** - –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∏ –∏–Ω—ä–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –æ–±—ä–µ–∫—Ç—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DI`:
	- —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–≤—è–∑–Ω–æ—Å—Ç–∏ (`low cohesion`) –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
	- –ø—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ç.–∫. –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ –º–æ–∫–∏ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö
	- –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
	- –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–æ–≤

### üìë–ö–∞–∫–∏–µ lifetime –≤ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç? –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞?

- **Transient**: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–∏—Å—É —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–∞. –í —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Å–µ—Ä–≤–∏—Å—É, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç. –ß–∞—â–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏  
<br/>
- **Scoped**: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–≤–æ–π –æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–∞. –¢–æ –µ—Å—Ç—å –µ—Å–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É, —Ç–æ –ø—Ä–∏ –≤—Å–µ—Ö —ç—Ç–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–∞.  
<br/>
- **Singleton**: –æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –Ω–µ–º—É, –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–∞

![[Pasted image 20250504163214.png]]

### üìë–ö–∞–∫ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ ASP.NET –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö?

üö© `BackgroundService`
üö© —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è`IHostedService`
üö© `QueueBackgroundWorkItem` (–≤ WebApplication)
üö© –µ—Å–ª–∏ –Ω—É–∂–µ–Ω `cron`, —Ç–æ `Hangfire` –∏–ª–∏ `Quartz.NET`

