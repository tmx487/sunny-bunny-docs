# Задание: Парсинг финансовой отчетности и расчет KPI компании

## Описание задачи

Вам предоставлен Excel файл с детализированной финансовой отчетностью крупной торговой компании за 2 года (2023-2024). Файл содержит более 150,000 записей транзакций из различных подразделений компании.

**Ваша задача:**
1. Создать высокопроизводительный парсер для обработки больших Excel файлов
2. Реализовать валидацию данных с детальной отчетностью об ошибках
3. Рассчитать ключевые показатели эффективности (KPI) компании
4. Обеспечить обработку файлов размером 100,000+ строк за разумное время
5. Покрыть код тестами, включая тесты производительности

## Структура данных

Файл содержит следующие колонки:

| Колонка        | Тип      | Описание                                                      | Пример                                        |
| -------------- | -------- | ------------------------------------------------------------- | --------------------------------------------- |
| TransactionID  | String   | Уникальный ID транзакции                                      | TXN-2024-001234                               |
| Date           | DateTime | Дата транзакции                                               | 2024-03-15                                    |
| Department     | String   | Подразделение                                                 | Sales, Marketing, IT, HR, Finance             |
| Category       | String   | Категория расхода/дохода                                      | Revenue, Salary, Equipment, Marketing, Travel |
| SubCategory    | String   | Подкатегория                                                  | Online Sales, Office Rent, Software License   |
| Amount         | Decimal  | Сумма (положительная для доходов, отрицательная для расходов) | 15000.50                                      |
| Currency       | String   | Валюта                                                        | USD, EUR, GBP                                 |
| ExchangeRate   | Decimal  | Курс к USD                                                    | 1.0000                                        |
| AmountUSD      | Decimal  | Сумма в USD                                                   | 15000.50                                      |
| EmployeeID     | String   | ID сотрудника                                                 | EMP-2024-0567                                 |
| ProjectCode    | String   | Код проекта                                                   | PRJ-WEBSITE-2024                              |
| CostCenter     | String   | Центр затрат                                                  | CC-SALES-NORTH                                |
| ApprovalStatus | String   | Статус утверждения                                            | Approved, Pending, Rejected                   |
| ApprovalDate   | DateTime | Дата утверждения                                              | 2024-03-16                                    |
| Description    | String   | Описание транзакции                                           | Monthly software subscription                 |
| Tags           | String   | Теги (через запятую)                                          | recurring,software,productivity               |

## Примеры данных

```
TransactionID,Date,Department,Category,SubCategory,Amount,Currency,ExchangeRate,AmountUSD,EmployeeID,ProjectCode,CostCenter,ApprovalStatus,ApprovalDate,Description,Tags
TXN-2024-001234,2024-03-15,Sales,Revenue,Online Sales,25000.00,USD,1.0000,25000.00,EMP-2024-0567,PRJ-ECOMMERCE-2024,CC-SALES-NORTH,Approved,2024-03-16,"Q1 online sales revenue","revenue,ecommerce,quarterly"
TXN-2024-001235,2024-03-15,IT,Equipment,Software License,-1200.00,USD,1.0000,-1200.00,EMP-2024-0123,PRJ-INFRASTRUCTURE-2024,CC-IT-CORE,Approved,2024-03-15,"Adobe Creative Suite annual license","software,recurring,design"
TXN-2024-001236,2024-03-14,Marketing,Marketing,Social Media Ads,-3500.00,EUR,0.9200,-3804.35,EMP-2024-0789,PRJ-CAMPAIGN-SPRING,CC-MARKETING-DIGITAL,Approved,2024-03-14,"Facebook and Instagram ad campaign","marketing,social,campaign"
TXN-2024-001237,2024-03-14,HR,Salary,Base Salary,-8500.00,USD,1.0000,-8500.00,EMP-2024-0234,PRJ-GENERAL-OPS,CC-HR-PAYROLL,Approved,2024-03-14,"Monthly salary - Senior Developer","salary,payroll,developer"
TXN-2024-001238,2024-03-13,Finance,Equipment,Office Supplies,-450.75,GBP,0.7800,-578.01,EMP-2024-0345,PRJ-OFFICE-SETUP,CC-FINANCE-ADMIN,Pending,,"Office supplies for new employees","supplies,office,onboarding"
TXN-2024-001239,2024-03-13,Sales,Travel,Business Travel,-2100.00,USD,1.0000,-2100.00,EMP-2024-0567,PRJ-CLIENT-MEETINGS,CC-SALES-WEST,Approved,2024-03-13,"Client meeting travel expenses","travel,client,sales"
TXN-2024-001240,2024-03-12,IT,Equipment,Hardware,-4500.00,USD,1.0000,-4500.00,EMP-2024-0123,PRJ-INFRASTRUCTURE-2024,CC-IT-HARDWARE,Approved,2024-03-12,"New server for production environment","hardware,server,infrastructure"
TXN-2024-001241,2024-03-12,Marketing,Marketing,Content Creation,-1800.00,USD,1.0000,-1800.00,EMP-2024-0789,PRJ-CONTENT-2024,CC-MARKETING-CONTENT,Approved,2024-03-12,"Video production services","content,video,marketing"
TXN-2024-001242,2024-03-11,Sales,Revenue,Corporate Sales,45000.00,USD,1.0000,45000.00,EMP-2024-0567,PRJ-ENTERPRISE-2024,CC-SALES-ENTERPRISE,Approved,2024-03-11,"Enterprise client contract payment","revenue,enterprise,contract"
TXN-2024-001243,2024-03-11,HR,Training,Professional Development,-2500.00,USD,1.0000,-2500.00,EMP-2024-0234,PRJ-TRAINING-2024,CC-HR-DEVELOPMENT,Approved,2024-03-11,"Cloud architecture certification course","training,certification,cloud"
```

## Бизнес-правила валидации

### Обязательные поля:
- TransactionID (формат: TXN-YYYY-NNNNNN)
- Date (не может быть в будущем, не раньше 2020-01-01)
- Department (только: Sales, Marketing, IT, HR, Finance)
- Category (только: Revenue, Salary, Equipment, Marketing, Travel, Training)
- Amount (не может быть 0)
- Currency (только: USD, EUR, GBP)
- ExchangeRate (больше 0)
- AmountUSD (должен соответствовать Amount * ExchangeRate)
- ApprovalStatus (только: Approved, Pending, Rejected)

### Условная валидация:
- Если ApprovalStatus = "Approved", то ApprovalDate обязательно
- Если ApprovalStatus = "Pending" или "Rejected", то ApprovalDate должно быть пустым
- Если Amount > 0, то Category должно быть "Revenue"
- Если Amount < 0, то Category не может быть "Revenue"
- EmployeeID должен быть формата EMP-YYYY-NNNN
- ProjectCode должен быть формата PRJ-НАЗВАНИЕ-YYYY

## Требуемые KPI для расчета

После успешного парсинга необходимо рассчитать следующие показатели:

### Финансовые KPI:
1. **Общая выручка** (сумма всех положительных Amount)
2. **Общие расходы** (сумма всех отрицательных Amount по модулю)
3. **Прибыль** (выручка - расходы)
4. **Рентабельность** (прибыль / выручка * 100%)
5. **Средний чек** (общая выручка / количество транзакций с положительным Amount)

### Операционные KPI:
1. **Расходы по подразделениям** (группировка по Department)
2. **Топ-5 самых дорогих транзакций**
3. **Средний срок утверждения** (ApprovalDate - Date для утвержденных транзакций)
4. **Доля отклоненных транзакций** (Rejected / общее количество)
5. **Сезонность продаж** (выручка по месяцам)

### Аналитические KPI:
1. **ROI по проектам** (доходы по проектам / расходы по проектам)
2. **Эффективность сотрудников** (количество и сумма транзакций по EmployeeID)
3. **Валютное распределение** (процент транзакций по валютам)
4. **Тренды расходов** (месячная динамика расходов по категориям)

## Требования к производительности

- **Скорость парсинга**: минимум 5,000 записей в секунду
- **Использование памяти**: не более 512 МБ для файла в 150,000 записей
- **Время отклика**: полная обработка 100,000 записей не более 30 секунд
- **Масштабируемость**: возможность обработки файлов до 1 млн записей

## Требования к тестированию

### Unit тесты:
- Валидация каждого бизнес-правила
- Парсинг различных форматов данных
- Обработка граничных случаев
- Расчет каждого KPI

### Integration тесты:
- Парсинг реальных файлов различного размера
- Полный workflow от файла до KPI
- Обработка ошибок и исключений

### Performance тесты:
- Бенчмарки для файлов 10K, 50K, 100K, 500K записей
- Тестирование памяти и производительности
- Нагрузочное тестирование

## Ожидаемые результаты

1. **Интерфейс IFinancialReportParser** с методами для парсинга
2. **Класс FinancialTransaction** для представления данных
3. **Класс FinancialValidator** для валидации данных
4. **Класс KPICalculator** для расчета показателей
5. **Класс ParseResult** с детальной информацией о результатах
6. **Полный набор тестов** с покрытием >90%

## Дополнительные сложности

- Файл может содержать дубликаты TransactionID
- Некоторые ячейки могут быть пустыми или содержать формулы
- Валютные курсы могут быть неточными (требуется валидация)
- Даты могут быть в разных форматах
- Описания могут содержать переносы строк и специальные символы
- Теги могут быть неконсистентными (разные разделители, регистр)
# Требования к тестам и ожидаемые метрики

## Структура тестов

### 1. Unit тесты валидации (`ValidationTests.cs`)

```csharp
[Theory]
[InlineData("TXN-2024-001234", true)]
[InlineData("TXN-24-001234", false)]
[InlineData("", false)]
public void ValidateTransactionID_ShouldReturnExpectedResult(string transactionId, bool expected)

[Fact]
public void ValidateAmount_WhenRevenueWithNegativeAmount_ShouldReturnError()

[Fact]
public void ValidateApprovalLogic_WhenApprovedWithoutDate_ShouldReturnError()
```

### 2. Performance тесты (`PerformanceTests.cs`)

```csharp
[Theory]
[InlineData(10_000)]
[InlineData(50_000)]
[InlineData(100_000)]
[InlineData(500_000)]
public async Task ParseFile_WithLargeDataset_ShouldMeetPerformanceRequirements(int recordCount)

[Fact]
public async Task ParseFile_MemoryUsage_ShouldNotExceedLimit()
```

### 3. Integration тесты (`IntegrationTests.cs`)

```csharp
[Fact]
public async Task ParseRealFile_WithMixedData_ShouldProduceCorrectKPIs()

[Fact]
public async Task ParseFile_WithCancellation_ShouldHandleGracefully()
```

## Ожидаемые метрики производительности

### Скорость парсинга:

- **10,000 записей**: < 2 секунды
- **50,000 записей**: < 8 секунд
- **100,000 записей**: < 15 секунд
- **500,000 записей**: < 60 секунд

### Использование памяти:

- **Базовое потребление**: < 50 МБ
- **10,000 записей**: < 100 МБ
- **100,000 записей**: < 300 МБ
- **500,000 записей**: < 800 МБ

### Точность парсинга:

- **Успешная обработка**: > 99.5% валидных записей
- **Время валидации**: < 20% от общего времени парсинга
- **Обнаружение ошибок**: 100% некорректных данных

## Тестовые данные

### Валидные паттерны:

```
TXN-2024-001234 (корректный TransactionID)
2024-03-15 (корректная дата)
Sales (корректное подразделение)
Revenue (корректная категория для положительной суммы)
25000.00 (корректная сумма)
USD (корректная валюта)
EMP-2024-0567 (корректный EmployeeID)
PRJ-ECOMMERCE-2024 (корректный ProjectCode)
```

### Невалидные паттерны:

```
TXN-24-001234 (неправильный год)
2025-03-15 (дата в будущем)
InvalidDept (некорректное подразделение)
Revenue с отрицательной суммой
0.00 (нулевая сумма)
RUB (неподдерживаемая валюта)
EMP-0567 (неправильный формат EmployeeID)
INVALID-PROJECT (неправильный формат ProjectCode)
```

## Критерии успешности

1. **Все тесты проходят** без ошибок
2. **Покрытие кода** > 90%
3. **Performance тесты** соответствуют требованиям
4. **Валидация** корректно обрабатывает все edge cases
5. **KPI расчеты** математически корректны
6. **Обработка ошибок** предсказуема и информативна

## Рекомендуемые NuGet пакеты

```xml
<PackageReference Include="ClosedXML" Version="0.102.2" />
<PackageReference Include="xunit" Version="2.4.2" />
<PackageReference Include="xunit.runner.visualstudio" Version="2.4.5" />
<PackageReference Include="Microsoft.Extensions.Logging" Version="8.0.0" />
<PackageReference Include="Microsoft.Extensions.Logging.Console" Version="8.0.0" />
<PackageReference Include="Moq" Version="4.20.70" />
<PackageReference Include="FluentAssertions" Version="6.12.0" />
<PackageReference Include="BenchmarkDotNet" Version="0.13.10" />
```

Это задание проверит ваши навыки работы с большими объемами данных, оптимизацией производительности, комплексной валидацией и расчетом бизнес-метрик!