
## Пессимистичная блокировка

Пессимистичная блокировка работает по принципу "предотвратить конфликты заранее". Основные характеристики:

- **Суть**: блокирует данные сразу при начале работы с ними
- **Как работает**: когда транзакция начинает работу с записью, она устанавливает блокировку, запрещающую другим транзакциям изменять эту запись
- **SQL-пример**:
    
```sql
BEGIN TRANSACTION;
SELECT * FROM products WHERE id = 123 FOR UPDATE; -- блокирует запись
-- работа с данными
UPDATE products SET quantity = quantity - 1 WHERE id = 123;COMMIT;
-- освобождает блокировку
```
    
- **Применение**: подходит для систем с высоким уровнем конкуренции за ресурсы, где конфликты вероятны

## Оптимистичная блокировка

Оптимистичная блокировка следует принципу "разрешить работу, проверять конфликты в конце". Основные характеристики:

- **Суть**: предполагает, что конфликты маловероятны, и разрешает параллельную работу
- **Как работает**: использует версионность данных или временные метки для обнаружения конфликтов в момент сохранения
- **SQL-пример**:
    
```sql
BEGIN TRANSACTION;
SELECT id, name, price, version FROM products WHERE id = 123;-- Запоминаем версию: version = 5-- работа с данными без блокировки-- При сохранении проверяем, не изменил ли кто-то запись:
UPDATE products SET price = 99.99, version = version + 1 WHERE id = 123 AND version = 5;-- Если счетчик обновленных строк = 0, значит произошел конфликт
IF @@ROWCOUNT = 0 THEN  ROLLBACK;  -- Обработка ошибки конфликта
ELSE  COMMIT;END IF;
```
    
- **Применение**: эффективно в системах с низкой вероятностью конфликтов доступа

## Ключевые отличия

|Аспект|Пессимистичная блокировка|Оптимистичная блокировка|
|---|---|---|
|Момент обнаружения конфликтов|В начале операции|В конце операции (при сохранении)|
|Производительность при малом количестве конфликтов|Ниже из-за лишних блокировок|Выше, т.к. нет блокировок|
|Производительность при большом количестве конфликтов|Стабильная, предотвращает повторные попытки|Ниже из-за частых откатов и повторов|
|Риск дедлоков|Высокий|Практически отсутствует|
|Сложность реализации|Проще, встроена в большинство СУБД|Сложнее, часто требует дополнительного кода|
|Расход ресурсов базы данных|Выше (держит блокировки)|Ниже (не держит блокировки)|
|Подход к конкуренции|"Предотвращение"|"Обнаружение и исправление"|

## Практические рекомендации по выбору

- **Выбирайте пессимистичную блокировку**, когда:
    
    - Высокая вероятность редактирования одних и тех же данных
    - Критичные бизнес-операции, где конфликты недопустимы
    - Транзакции короткие и выполняются быстро
- **Выбирайте оптимистичную блокировку**, когда:
    
    - Низкая вероятность конфликтов
    - Высокая нагрузка на систему с большим количеством одновременных пользователей
    - Нужна высокая масштабируемость
    - Транзакции могут быть длительными