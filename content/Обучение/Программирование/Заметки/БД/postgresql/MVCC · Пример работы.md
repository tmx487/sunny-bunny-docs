## üìò –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç [[MVCC (multiversion concurrency control)|MVCC]] –≤ PostgreSQL (ChatGPT)

PostgreSQL —Ä–µ–∞–ª–∏–∑—É–µ—Ç MVCC —á–µ—Ä–µ–∑ **—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫** –≤ —Ç–∞–±–ª–∏—Ü–µ.

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ:

- –∏–º–µ–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `xmin` (–∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω–∞) –∏ `xmax` (–∫–æ–≥–¥–∞ —É–¥–∞–ª–µ–Ω–∞/–∑–∞–º–µ–Ω–µ–Ω–∞)
    
- —Ö—Ä–∞–Ω–∏—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–º—É –Ω–µ –Ω—É–∂–Ω–∞ (=> –∞–≤—Çovacuum –ø–æ—Ç–æ–º —É–¥–∞–ª—è–µ—Ç)
    

### üîÑ –ü—Ä–∏–º–µ—Ä:

–ü—É—Å—Ç—å —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `users` —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π:

```sql
id | name
---|-----
 1 | Alice
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π:

1. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A (TxA)** –∑–∞–ø—É—Å–∫–∞–µ—Ç:
    
    ```sql
    BEGIN;
    SELECT * FROM users WHERE id = 1;
    -- –í–∏–¥–∏—Ç: Alice
    ```
    
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B (TxB)** –¥–µ–ª–∞–µ—Ç:
    
    ```sql
    BEGIN;
    UPDATE users SET name = 'Bob' WHERE id = 1;
    COMMIT;
    ```
    
3. **TxA** –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É:
    
    ```sql
    SELECT * FROM users WHERE id = 1;
    -- –í—Å—ë –µ—â—ë –≤–∏–¥–∏—Ç: Alice
    ```
    

‚úî –ü–æ—á–µ–º—É? –ü–æ—Ç–æ–º—É —á—Ç–æ **TxA —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–≤–æ—ë–º snapshot-–µ** ‚Äî –æ–Ω–∞ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–æ –µ—ë —Å—Ç–∞—Ä—Ç–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ TxB –Ω–µ –≤–∏–¥–Ω–æ, –ø–æ–∫–∞ TxA –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

---

### üîÅ UPDATE ‚Üí –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å, –∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è

```sql
UPDATE users SET name = 'Bob' WHERE id = 1;
```

‚Üí PostgreSQL **–Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** —Å—Ç—Ä–æ–∫—É, –∞:

- –ø–æ–º–µ—á–∞–µ—Ç —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É `xmax = id —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏`
    
- –≤—Å—Ç–∞–≤–ª—è–µ—Ç **–Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é** —Å—Ç—Ä–æ–∫–∏ `xmax = null`, `xmin = id —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏`
    

---

### üßπ –ê –∫–∞–∫ —É–¥–∞–ª—è—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏?

–ß–µ—Ä–µ–∑ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É** ‚Äî **Autovacuum**:

- –û–Ω —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ **—É–∂–µ –Ω–∏–∫–µ–º –Ω–µ –≤–∏–¥–Ω—ã**.
    
- –ò–Ω–∞—á–µ —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ —Ä–∞–∑—Ä–∞—Å—Ç–∞—Ç—å—Å—è.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç [[MVCC (multiversion concurrency control)|MVCC]] –≤ PostgreSQL (Claude)

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MVCC, —Å–æ–∑–¥–∞–≤–∞—è "—Å–Ω–∏–º–∫–∏" (snapshots) –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

1. **–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π**
    - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏
    - –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, –∞ —Å—Ç–∞—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
2. **–ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
3. **–°—Ç—Ä–æ–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã**:
    - `xmin` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–æ–∑–¥–∞–≤—à–µ–π —Å—Ç—Ä–æ–∫—É
    - `xmax` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —É–¥–∞–ª–∏–≤—à–µ–π —Å—Ç—Ä–æ–∫—É (–∏–ª–∏ 0, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞)
    - `cmin/cmax` - —Å—á–µ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã MVCC –≤ PostgreSQL

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `accounts`:

```sql
CREATE TABLE accounts (
    id INT PRIMARY KEY,
    name TEXT,
    balance INT
);

INSERT INTO accounts VALUES (1, '–ê–ª–µ–∫—Å–µ–π', 1000);
```

### –°—Ü–µ–Ω–∞—Ä–∏–π —Å –¥–≤—É–º—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:

#### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π):

```sql
BEGIN;
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 –≤–∏–¥–∏—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
SELECT * FROM accounts WHERE id = 1;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: (1, '–ê–ª–µ–∫—Å–µ–π', 1000)
```

#### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2 (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–∫–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 –∞–∫—Ç–∏–≤–Ω–∞, —Ç.–µ. –µ—â–µ –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞):

```sql
BEGIN;
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2 –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
UPDATE accounts SET balance = 1500 WHERE id = 1;
COMMIT;
```

#### –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 1:

```sql
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 –≤—Å–µ –µ—â–µ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –¥–∞–∂–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 2
SELECT * FROM accounts WHERE id = 1;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: (1, '–ê–ª–µ–∫—Å–µ–π', 1000)
COMMIT;
```

#### –ù–æ–≤–∞—è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 3 (–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–µ–∏—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö):

```sql
BEGIN;
SELECT * FROM accounts WHERE id = 1;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: (1, '–ê–ª–µ–∫—Å–µ–π', 1500)
COMMIT;
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ PostgreSQL:

1. **–ö–æ–≥–¥–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2 –≤—ã–ø–æ–ª–Ω—è–µ—Ç UPDATE**:
    - PostgreSQL –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
    - –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏ (1, '–ê–ª–µ–∫—Å–µ–π', 1500) —Å xmin = ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 2
    - –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è (xmax = ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 2)
2. **–ö–æ–≥–¥–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ**:
    - PostgreSQL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1 –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ –µ—ë –Ω–∞—á–∞–ª–∞ –∏ –Ω–µ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞
    - –ü–æ—ç—Ç–æ–º—É –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏
3. **–ö–æ–≥–¥–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 3 —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ**:
    - –û–Ω–∞ –≤–∏–¥–∏—Ç —É–∂–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–∞—Ä–∞—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ MVCC

1. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å** - —á—Ç–µ–Ω–∏–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å, –∑–∞–ø–∏—Å—å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ
2. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. **–ò–∑–æ–ª—è—Ü–∏—è** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞

## –û—á–∏—Å—Ç–∫–∞ (VACUUM)

–ü–æ—Å–∫–æ–ª—å–∫—É MVCC —Å–æ–∑–¥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫, —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≤–µ—Ä—Å–∏–∏. –ü—Ä–æ—Ü–µ—Å—Å VACUUM –≤ PostgreSQL —É–¥–∞–ª—è–µ—Ç —ç—Ç–∏ "–º–µ—Ä—Ç–≤—ã–µ" —Å—Ç—Ä–æ–∫–∏, –æ—Å–≤–æ–±–æ–∂–¥–∞—è –º–µ—Å—Ç–æ.

```sql
VACUUM accounts; -- —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏
```

‚ùó‚ö°**–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å –æ—á–∏—Å—Ç–∫–∏ (autovacuum).**