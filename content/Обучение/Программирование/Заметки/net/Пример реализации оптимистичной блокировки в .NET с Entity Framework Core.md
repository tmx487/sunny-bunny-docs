
## üß† –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–µ–º:

- –î–æ–±–∞–≤–∏–º –ø–æ–ª–µ `RowVersion` –≤ —Å—É—â–Ω–æ—Å—Ç—å
    
- –û–±–æ–∑–Ω–∞—á–∏–º –µ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–æ–º `[Timestamp]`
    
- EF Core –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤–µ—Ä—Å–∏–π
    

---

## üß© –ü—Ä–∏–º–µ—Ä: —Å—É—â–Ω–æ—Å—Ç—å `Document`

```csharp
using System.ComponentModel.DataAnnotations;

public class Document
{
    public int Id { get; set; }

    public string Title { get; set; }

    // –ü–æ–ª–µ –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    [Timestamp]
    public byte[] RowVersion { get; set; }
}
```

---

## üóÇÔ∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç `AppDbContext`

```csharp
using Microsoft.EntityFrameworkCore;

public class AppDbContext : DbContext
{
    public DbSet<Document> Documents { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Document>()
            .Property(d => d.RowVersion)
            .IsRowVersion(); // –í–∞–∂–Ω–æ!
    }
}
```

---

## ‚öôÔ∏è –ü—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

```csharp
using (var context = new AppDbContext())
{
    var doc = await context.Documents.FirstAsync(d => d.Id == 1);

    doc.Title = "Updated Title";

    try
    {
        await context.SaveChangesAsync();
    }
    catch (DbUpdateConcurrencyException ex)
    {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
        Console.WriteLine("‚ö† –ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤–µ—Ä—Å–∏–π! –ö—Ç–æ-—Ç–æ —É–∂–µ –æ–±–Ω–æ–≤–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç.");
        
        // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
    }
}
```

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

- EF Core –¥–æ–±–∞–≤–ª—è–µ—Ç `WHERE RowVersion = ...` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    
- –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —É–∂–µ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ `RowVersion` –±—É–¥–µ—Ç –¥—Ä—É–≥–∏–º
    
- `SaveChangesAsync()` –≤–µ—Ä–Ω—ë—Ç 0 –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —Å—Ç—Ä–æ–∫ ‚Üí EF –≤—ã–±—Ä–æ—Å–∏—Ç `DbUpdateConcurrencyException`

# üîÑ –ü–æ–≤—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

–ü–æ–∫–∞–∂—É, –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è** –ø—Ä–∏ **–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ**, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 3 —Ä–∞–∑. –≠—Ç–æ —É–¥–æ–±–Ω–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–∞–ª–æ—Å—å —Å–∞–º–æ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## –ü–æ–≤—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ

```csharp
using Microsoft.EntityFrameworkCore;
using System;

public async Task<bool> TryUpdateDocumentAsync(int documentId, string newTitle)
{
    const int maxRetries = 3;

    for (int attempt = 1; attempt <= maxRetries; attempt++)
    {
        using var context = new AppDbContext();

        var doc = await context.Documents.FirstOrDefaultAsync(d => d.Id == documentId);

        if (doc == null)
            return false;

        doc.Title = newTitle;

        try
        {
            await context.SaveChangesAsync();
            Console.WriteLine("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.");
            return true;
        }
        catch (DbUpdateConcurrencyException)
        {
            Console.WriteLine($"‚ö† –ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤–µ—Ä—Å–∏–π (–ø–æ–ø—ã—Ç–∫–∞ {attempt}).");

            if (attempt == maxRetries)
            {
                Console.WriteLine("‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ. –û—Ç–º–µ–Ω–∞.");
                return false;
            }

            // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            foreach (var entry in context.ChangeTracker.Entries())
            {
                await entry.ReloadAsync(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            }

            // –ü–æ–≤—Ç–æ—Ä ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ
        }
    }

    return false;
}
```

---

## üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥

- –°—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
    
- –ü—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    
- –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ **–ø—ã—Ç–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞**
    
- –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞ `maxRetries` —Ä–∞–∑ ‚Äî **–æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è** –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
    

---

## üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

- –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    
- –î–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ: _¬´–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —á—É–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å?¬ª_
    
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)