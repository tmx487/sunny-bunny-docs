–ó–∞–ø—Ä–µ—â–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é `await` –≤–Ω—É—Ç—Ä–∏ [[lock ¬∑ –î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–æ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è|lock]] ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–∞–ø—Ä–∏–∑ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞, –∞ –∑–∞—â–∏—Ç–∞ –æ—Ç **–≤–µ—Å—å–º–∞ –æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è**, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ **deadlock‚Äô–∞–º –∏ –¥—Ä—É–≥–∏–º –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ—Å—Ç—è–º**.

---

## üö´ –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è `await` –≤–Ω—É—Ç—Ä–∏ `lock`?

–ü–æ—Ç–æ–º—É —á—Ç–æ [[lock ¬∑ –î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–æ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è|lock]] (–∏ –µ–≥–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç `Monitor.Enter`) **–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫**, –Ω–æ `await` **–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥**.

### –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:

```csharp
lock (_syncObj)
{
    await DoSomethingAsync(); // ‚ùå –æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
}
```

- `lock` —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä (`Monitor.Enter`) –Ω–∞ `_syncObj`
    
- `await` **–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥** –∏ –æ—Ç–ø—É—Å–∫–∞–µ—Ç –ø–æ—Ç–æ–∫ (–Ω–æ –Ω–µ lock!)
    
- –ø–æ—Å–ª–µ `await` –º–µ—Ç–æ–¥ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **–Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ç–æ–∫–µ**, –Ω–æ **lock –≤—Å—ë –µ—â—ë –∑–∞—Ö–≤–∞—á–µ–Ω**
    
- ‚Üí üî• **[[–û–±—É—á–µ–Ω–∏–µ/–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ/–ó–∞–º–µ—Ç–∫–∏/net/–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å/deadlock]]** –∏–ª–∏ **–∏—Å–∫–ª—é—á–µ–Ω–∏–µ**, –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –∑–∞—Ö–æ—á–µ—Ç –≤–æ–π—Ç–∏ –≤ —Ç–æ—Ç –∂–µ `lock`
    

---

## ‚ö†Ô∏è –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã

```csharp
lock (_lockObj)
{
    // –ø–æ—Ç–æ–∫ 1
    await Task.Delay(1000); // –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç lock!
    // –ø–æ—Ç–æ–∫ 2 –≤ —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ–≤–∏—Å–Ω–µ—Ç, –æ–∂–∏–¥–∞—è lock ‚Äî DEADLOCK
}
```

---

## ‚úÖ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?

–í–º–µ—Å—Ç–æ `lock` –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏**, –Ω–∞–ø—Ä–∏–º–µ—Ä:

### üîπ `SemaphoreSlim`

```csharp
private readonly SemaphoreSlim _semaphore = new SemaphoreSlim(1, 1);

public async Task SafeAsyncMethod()
{
    await _semaphore.WaitAsync(); // –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∂–¥—ë–º –¥–æ—Å—Ç—É–ø

    try
    {
        await DoSomethingAsync(); // —Ç–µ–ø–µ—Ä—å await –±–µ–∑–æ–ø–∞—Å–µ–Ω
    }
    finally
    {
        _semaphore.Release(); // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –¥–æ—Å—Ç—É–ø
    }
}
```

---

## üìå –ò—Ç–æ–≥–æ

|–ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è `await` –≤ `lock`|–ß—Ç–æ –¥–µ–ª–∞—Ç—å|
|---|---|
|`lock` –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫, `await` –µ–≥–æ –æ—Ç–ø—É—Å–∫–∞–µ—Ç|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SemaphoreSlim`|
|`await` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫, –∞ `lock` ‚Äî –ø–æ—Ç–æ–∫–æ–∑–∞–≤–∏—Å–∏–º|–í–º–µ—Å—Ç–æ `lock`, –±–µ—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏|
|–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π deadlock|–í—Å–µ–≥–¥–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–π —Ä–µ—Å—É—Ä—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ|

---

–•–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: `lock` vs `SemaphoreSlim` –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é.