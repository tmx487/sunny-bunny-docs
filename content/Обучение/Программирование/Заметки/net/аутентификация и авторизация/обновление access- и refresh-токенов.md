–ü–æ—á—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω—é–∞–Ω—Å–æ–≤. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –ø—Ä–æ—Ü–µ—Å—Å **–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access-—Ç–æ–∫–µ–Ω–∞ —Å –ø–æ–º–æ—â—å—é refresh-—Ç–æ–∫–µ–Ω–∞**.

---

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access-—Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ refresh-—Ç–æ–∫–µ–Ω?**

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API**, **–¥–æ–±–∞–≤–ª—è—è access-—Ç–æ–∫–µ–Ω** –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <access_token>`.
2. **–ï—Å–ª–∏ access-—Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω**, —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç **401 Unauthorized**.
3. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞**, **–ø–µ—Ä–µ–¥–∞–≤–∞—è refresh-—Ç–æ–∫–µ–Ω** (–æ–±—ã—á–Ω–æ –≤ `body` –∏–ª–∏ `Authorization` –∑–∞–≥–æ–ª–æ–≤–∫–µ).
4. **–°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω**:
    - **–ò—â–µ—Ç –µ–≥–æ –≤ –ë–î**.
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç **—Å—Ä–æ–∫ –∂–∏–∑–Ω–∏**.
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, **—Å–≤—è–∑–∞–Ω –ª–∏ –æ–Ω —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º**.
5. **–ï—Å–ª–∏ –≤—Å—ë –æ–∫**, —Å–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:
    - **–ù–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω**.
    - **–ù–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω** (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –Ω–æ –ª—É—á—à–µ –æ–±–Ω–æ–≤–ª—è—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞).
    - –û–±–Ω–æ–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î.
6. **–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω (–∏, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω)**.
7. **–ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω** –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

---

### **–ö–∞–∫ –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å refresh-—Ç–æ–∫–µ–Ω–æ–º?**

- **–ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ** (—ç—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ).
- **Refresh-—Ç–æ–∫–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç** `/api/auth/refresh-token`, –∫–æ–≥–¥–∞ access-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫.

---

### **–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –∫–æ–¥–µ (ASP.NET Core, Identity)?**

#### **1. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**

```csharp
[HttpPost("refresh-token")]
public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)
{
    var response = await authService.RefreshTokenAsync(request.RefreshToken);
    
    if (response == null)
        return Unauthorized("Invalid or expired refresh token");

    return Ok(response);
}

```

üìå **–¢—É—Ç —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç refresh-—Ç–æ–∫–µ–Ω –∏ access-—Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω, –∏ –µ—Å–ª–∏ –æ–Ω –≤–∞–ª–∏–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω.**

---

#### **2. –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ (`AuthService`)**

```csharp
public async Task<AuthResponse?> RefreshTokenAsync(string refreshToken)
{
    // –ò—â–µ–º refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î
    var storedRefreshToken = await authDbContext.UserTokens
        .FirstOrDefaultAsync(t => t.LoginProvider == "RefreshToken" && t.Value == refreshToken);

    if (storedRefreshToken == null || DateTime.UtcNow > storedRefreshToken.Expiration)
        return null; // Refresh-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    var user = await userManager.FindByIdAsync(storedRefreshToken.UserId);
    if (user == null)
        return null;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω
    var newAccessToken = tokenService.GenerateAccessToken(user);
    var newRefreshToken = tokenService.GenerateRefreshToken();

    // –û–±–Ω–æ–≤–ª—è–µ–º refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î
    storedRefreshToken.Value = newRefreshToken;
    storedRefreshToken.Expiration = DateTime.UtcNow.AddDays(7);
    await authDbContext.SaveChangesAsync();

    return new AuthResponse
    {
        AccessToken = newAccessToken,
        RefreshToken = newRefreshToken
    };
}

```

üìå **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**

- **–ò–∑ access-—Ç–æ–∫–µ–Ω–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**.
- **Refresh-—Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –ë–î**.
- **–ï—Å–ª–∏ –≤—Å—ë –æ–∫, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω –∏ –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω**.
- **–û–±–Ω–æ–≤–ª—è–µ–º refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω –∫–ª–∏–µ–Ω—Ç—É**.

---

### **–í—ã–≤–æ–¥**

- –ö–ª–∏–µ–Ω—Ç **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ**.
- –ö–ª–∏–µ–Ω—Ç **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ access-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫**.
- **–°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î**, –∏ –µ—Å–ª–∏ –æ–Ω –≤–∞–ª–∏–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω.
- **–õ—É—á—à–µ –æ–±–Ω–æ–≤–ª—è—Ç—å refresh-—Ç–æ–∫–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏** (—á—Ç–æ–±—ã –µ–≥–æ –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ, –µ—Å–ª–∏ –æ–Ω —É—Ç—ë–∫).

–≠—Ç–æ **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥**. üöÄ