# Index

- [[#üìå **–ü—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏**]]
	- [[#**üìå –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è?**]]
	- [[#**üìå –ò—Ç–æ–≥**]]
- [[#**üîπ–ê —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–µ ?**]]
	- [[#**üìå –ß—Ç–æ —É–ª—É—á—à–∞—é—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ?**]]
	- [[#**üìå –ò—Ç–æ–≥**]]
- [[#**üîπEvent sourcing + CQRS –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î**]]
	- [[#**üìå –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ë–î?**]]
	- [[#**üìå –ü—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ**]]
	- [[#**üìå –ó–∞—á–µ–º —Ç–∞–∫ –¥–µ–ª–∞—Ç—å?**]]
	- [[#**üìå –ö–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ë–î?**]]


–î–∞, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–¥—É–º–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º—Å—è, –∫–∞–∫ —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å.

---

## üìå **–ü—Ä–æ–±–ª–µ–º–∞: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏**

–ï—Å–ª–∏ `UserService` –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç `UserRepository` –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, —Ç–æ –æ–Ω **—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–Ω—É–∂–Ω–æ–π –ø—Ä–æ–∫–ª–∞–¥–∫–æ–π**. –ù–∞–ø—Ä–∏–º–µ—Ä:

### ‚ùå **–ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏**

```csharp
public class UserRepository
{
    private readonly DbContext _dbContext;

    public async Task<User?> GetByIdAsync(Guid userId)
    {
        return await _dbContext.Users.FindAsync(userId);
    }
}
```

```csharp
public class UserService
{
    private readonly IUserRepository _userRepository;

    public async Task<User?> GetUserByIdAsync(Guid userId)
    {
        return await _userRepository.GetByIdAsync(userId); // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤
    }
}
```

–¢–æ–≥–¥–∞ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ –º—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º `repository` —á–µ—Ä–µ–∑ `service`, –∏ —Å–µ—Ä–≤–∏—Å **–Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç**. –≠—Ç–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.

---

## **üìå –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è?**

–ù—É–∂–Ω–æ **—Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**:

- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π** –æ—Ç–≤–µ—á–∞–µ—Ç **–∑–∞ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º**.
- **–°–µ—Ä–≤–∏—Å** –¥–æ–±–∞–≤–ª—è–µ—Ç **–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É** (–≤–∞–ª–∏–¥–∞—Ü–∏—é, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –∏ —Ç. –¥.).
- **[[CQRS —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ handlers#**üìå –ß—Ç–æ —Ç–∞–∫–æ–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤ CQRS?**|–•–µ–Ω–¥–ª–µ—Ä]]** –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç **–ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—ç—à, –ª–æ–≥–∏).

---

## **‚úÖ –•–æ—Ä–æ—à–∏–π –ø–æ–¥—Ö–æ–¥**

### **1Ô∏è‚É£ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞ —Å –ë–î**

```csharp
public class UserRepository : IUserRepository
{
    private readonly DbContext _dbContext;

    public async Task<User?> GetByIdAsync(Guid userId)
    {
        return await _dbContext.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == userId);
    }
}
```

üí° **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –±–µ–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.**

---

### **2Ô∏è‚É£ –°–µ—Ä–≤–∏—Å: —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞**

```csharp
public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;

    public async Task<UserDto> GetUserByIdAsync(Guid userId)
    {
        var user = await _userRepository.GetByIdAsync(userId)
            ?? throw new NotFoundException("User not found");

        if (!user.IsActive)
        {
            throw new BusinessRuleException("User is inactive");
        }

        return new UserDto(user);
    }
}
```

üîπ **–ß—Ç–æ –¥–æ–±–∞–≤–∏–ª–æ—Å—å?**  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –µ—Å–ª–∏ `user == null`.  
‚úÖ –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–æ: –Ω–µ–ª—å–∑—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å `inactive` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.  
‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `User -> UserDto`.

---

### **3Ô∏è‚É£ –•–µ–Ω–¥–ª–µ—Ä: –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –≤–µ—â–∏ (–∫—ç—à, –ª–æ–≥–∏, –≤–∞–ª–∏–¥–∞—Ü–∏—é)**

```csharp
public class GetUserByIdHandler : IRequestHandler<GetUserByIdQuery, UserDto>
{
    private readonly IUserService _userService;
    private readonly ICacheService _cacheService;
    private readonly ILogger<GetUserByIdHandler> _logger;

    public GetUserByIdHandler(IUserService userService, ICacheService cacheService, ILogger<GetUserByIdHandler> logger)
    {
        _userService = userService;
        _cacheService = cacheService;
        _logger = logger;
    }

    public async Task<UserDto> Handle(GetUserByIdQuery request, CancellationToken cancellationToken)
    {
        _logger.LogInformation($"Fetching user {request.UserId}");

        var cacheKey = $"user_{request.UserId}";
        var cachedUser = await _cacheService.GetAsync<UserDto>(cacheKey);
        if (cachedUser is not null)
        {
            return cachedUser;
        }

        var userDto = await _userService.GetUserByIdAsync(request.UserId);

        await _cacheService.SetAsync(cacheKey, userDto, TimeSpan.FromMinutes(10));
        return userDto;
    }
}
```

üîπ **–ß—Ç–æ –¥–æ–±–∞–≤–∏–ª–æ—Å—å?**  
‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ **(–Ω–µ –≤ —Å–µ—Ä–≤–∏—Å–µ, –∞ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ)**  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
‚úÖ –í—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–∞

---

## **üìå –ò—Ç–æ–≥**

–¢–∞–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ **–∏–∑–±–µ–≥–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** –∏ **—Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**:

|–ö–æ–º–ø–æ–Ω–µ–Ω—Ç|–ó–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç?|
|---|---|
|**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**|–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î|
|**–°–µ—Ä–≤–∏—Å**|–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∏, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è)|
|**–•–µ–Ω–¥–ª–µ—Ä**|–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫—ç—à, –≤–∞–ª–∏–¥–∞—Ü–∏—è)|

üí° **–¢–µ–ø–µ—Ä—å —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –∞ –¥–æ–±–∞–≤–ª—è—é—Ç —Ü–µ–Ω–Ω–æ—Å—Ç—å!**

## **üîπ–ê —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–µ ?**

–ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç **Clean Architecture + CQRS**. –û–¥–Ω–∞–∫–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å **—É—Å–ª–æ–∂–Ω–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ **—Ä–µ–∞–ª—å–Ω—ã—Ö** —É–ª—É—á—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç –≤ –∫—Ä—É–ø–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö.

---

## **üìå –ß—Ç–æ —É–ª—É—á—à–∞—é—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ?**

### **1Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫—ç—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è**

–ü—Ä–æ—Å—Ç–æ–π –∫—ç—à (`ICacheService`) —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è, –∫—ç—à —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç. –ù–∞ –ø—Ä–æ–¥–µ –¥–µ–ª–∞—é—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –∫—ç—à–∞** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

üõ† **–ö–∞–∫ –¥–µ–ª–∞—é—Ç?**  
üîπ –ò—Å–ø–æ–ª—å–∑—É—é—Ç **Pub/Sub (–Ω–∞–ø—Ä–∏–º–µ—Ä, Redis –∏–ª–∏ RabbitMQ)**.  
üîπ –ö–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è ‚Üí —Å–µ—Ä–≤–∏—Å –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `"UserUpdated"` ‚Üí —Å–ª—É—à–∞—Ç–µ–ª—å –æ—á–∏—â–∞–µ—Ç –∫—ç—à.

```csharp
public class UserUpdatedEventHandler : INotificationHandler<UserUpdatedEvent>
{
    private readonly ICacheService _cacheService;

    public async Task Handle(UserUpdatedEvent notification, CancellationToken cancellationToken)
    {
        var cacheKey = $"user_{notification.UserId}";
        await _cacheService.RemoveAsync(cacheKey);
    }
}
```

---

### **2Ô∏è‚É£ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ë–î**

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ —Ä–æ–ª–∏**, –ª—É—á—à–µ –Ω–µ –¥–µ–ª–∞—Ç—å 2 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞, –∞ **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Include()` –∏–ª–∏ `Select`**.

üî¥ **–ü–ª–æ—Ö–æ (–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤):**

```csharp
var user = await _dbContext.Users.FirstOrDefaultAsync(u => u.Id == userId);
var roles = await _dbContext.UserRoles.Where(r => r.UserId == userId).Select(r => r.Role).ToListAsync();
```

‚úÖ **–•–æ—Ä–æ—à–æ (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å):**

```csharp
var user = await _dbContext.Users
    .Include(u => u.UserRoles)
    .ThenInclude(ur => ur.Role)
    .FirstOrDefaultAsync(u => u.Id == userId);
```

---

### **3Ô∏è‚É£ Command –∏ Query —Ä–∞–∑–¥–µ–ª—è—é—Ç –ë–î-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**

–í CQRS –º–æ–∂–Ω–æ **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –±–∞–∑—ã** –¥–ª—è –∫–æ–º–∞–Ω–¥ (`Write`) –∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (`Read`).

üõ† **–ö–∞–∫ –¥–µ–ª–∞—é—Ç?**  
üîπ –ß—Ç–µ–Ω–∏–µ (`Query`) ‚Üí –∏–¥–µ—Ç –≤ **—Ä–µ–ø–ª–∏–∫—É** –ë–î (–±—ã—Å—Ç—Ä–æ).  
üîπ –ó–∞–ø–∏—Å—å (`Command`) ‚Üí –∏–¥—ë—Ç –≤ **–º–∞—Å—Ç–µ—Ä-–ë–î** (–Ω–∞–¥–µ–∂–Ω–æ).

–ü—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ:

```csharp
public class QueryDbContext : DbContext { /* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–ø–ª–∏–∫–µ */ }
public class CommandDbContext : DbContext { /* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–∞—Å—Ç–µ—Ä-–ë–î */ }
```

---

### **4Ô∏è‚É£ CQRS + Event Sourcing**

–í–º–µ—Å—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä—è–º–æ –≤ –ë–î, **–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è** (`UserCreated`, `UserUpdated`, —á–∏—Ç–∞–π [[#Event sourcing + CQRS –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î|–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ]]).

üîπ **–ó–∞—á–µ–º?**  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äì –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ, –∫—Ç–æ —á—Ç–æ –º–µ–Ω—è–ª.  
‚úÖ **–û—Ç–∫–∞—Ç –¥–∞–Ω–Ω—ã—Ö** ‚Äì –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é.  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äì –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã.

–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏—è:

```csharp
public class UserUpdatedEvent : IDomainEvent
{
    public Guid UserId { get; }
    public string OldEmail { get; }
    public string NewEmail { get; }
}
```

---

## **üìå –ò—Ç–æ–≥**

–ù–∞ –ø—Ä–æ–¥–µ **—Ä–∞–∑–¥–µ–ª—è—é—Ç —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å, –¥–µ–ª–∞—é—Ç –∫—ç—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –ë–î-–∑–∞–ø—Ä–æ—Å—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Event Sourcing**.

–¢–≤–æ–π –ø–æ–¥—Ö–æ–¥ **—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –ø—Ä–æ—Å—Ç–æ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –µ–≥–æ –¥–æ–ø–æ–ª–Ω—è—é—Ç **–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏**! üöÄ

## **üîπEvent sourcing + CQRS: –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î**

–ü—Ä–∏ **Event Sourcing** –¥–∞–Ω–Ω—ã–µ **–Ω–µ —Å—Ä–∞–∑—É** –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∞ —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ **–∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π (event store)**.

### **üìå –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ë–î?**

1Ô∏è‚É£ **–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π (Event Store)** ‚Üí —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, PostgreSQL, EventStoreDB, Kafka, DynamoDB).  
2Ô∏è‚É£ **–û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Message Queue)** ‚Üí Kafka, RabbitMQ, AWS SQS.  
3Ô∏è‚É£ **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (In-memory storage)** ‚Üí Redis, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—ç—à–∏.

üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ **`UserUpdated`**.
- –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ **–Ω–µ —Å—Ä–∞–∑—É –º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `Users`**, –∞ **–ø–æ–ø–∞–¥–∞–µ—Ç –≤ Event Store**.
- –§–æ–Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã (Event Processors) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –∏ **–æ–±–Ω–æ–≤–ª—è—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ë–î**.

---

### **üìå –ü—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ**

1Ô∏è‚É£ **–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è**

```csharp
public class UserUpdatedEvent : IDomainEvent
{
    public Guid UserId { get; }
    public string OldEmail { get; }
    public string NewEmail { get; }
    public DateTime OccurredOn { get; } = DateTime.UtcNow;
}
```

2Ô∏è‚É£ **–ó–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π (Event Store)**

```csharp
await eventStore.SaveAsync(new UserUpdatedEvent(user.Id, oldEmail, newEmail));
```

3Ô∏è‚É£ **–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î**

```csharp
public async Task ProcessEvent(UserUpdatedEvent @event)
{
    var user = await _dbContext.Users.FindAsync(@event.UserId);
    user.Email = @event.NewEmail;
    await _dbContext.SaveChangesAsync();
}
```

---

### **üìå –ó–∞—á–µ–º —Ç–∞–∫ –¥–µ–ª–∞—Ç—å?**

‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** ‚Äì –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äì –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã.  
‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** ‚Äì —É–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –ë–î.  
‚úÖ **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** ‚Äì –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–ø–∞–¥—ë—Ç, —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è.

---

### **üìå –ö–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ë–î?**

- –û–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ **–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ —Å–µ–∫—É–Ω–¥—ã**, –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏–¥—ë—Ç –±—ã—Å—Ç—Ä–æ.
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π**, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è **—á—É—Ç—å –ø–æ–∑–∂–µ** (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏).

üìå **–ò—Ç–æ–≥**  
–°–æ–±—ã—Ç–∏—è **—Å–Ω–∞—á–∞–ª–∞** –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∂—É—Ä–Ω–∞–ª (Event Store), –∞ –ø–æ—Ç–æ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ë–î. –≠—Ç–æ –¥–∞—ë—Ç **–≥–∏–±–∫–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å. –í **–æ–±—ã—á–Ω—ã—Ö CRUD-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö** Event Sourcing **–Ω–µ –Ω—É–∂–µ–Ω**, –Ω–æ –æ–Ω –ø–æ–ª–µ–∑–µ–Ω –≤ **–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö** (–±–∞–Ω–∫–∏–Ω–≥, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, —Ñ–∏–Ω–∞–Ω—Å—ã). üöÄ

## üîπ**–ê —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å ?**

## **üìå –ì–¥–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å DTO?**

1Ô∏è‚É£ **Application —Å–ª–æ–π** ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å–≤–æ–∏ DTO** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

- –ù–∞–ø—Ä–∏–º–µ—Ä, `UserDto` –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö **–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Roles`).

2Ô∏è‚É£ **API —Å–ª–æ–π** ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å–≤–æ–∏ DTO** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏.

- –ú–æ–∂–µ—Ç –±—ã—Ç—å **–æ—Ç–¥–µ–ª—å–Ω–∞—è DTO-–º–æ–¥–µ–ª—å**, –∫–æ—Ç–æ—Ä–∞—è —Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–ª—è.
- –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è API **–Ω–µ –Ω—É–∂–µ–Ω `PasswordHash`**, –Ω–æ –≤ Application DTO –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å.

---

## **üìå –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ?**

–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî **—Ä–∞–∑–¥–µ–ª–∏—Ç—å DTO**, –∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –∫–ª–∞—Å—Å—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Å–ª–æ—è—Ö.

### **üìå –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

- **Application.DTOs**
    
    ```csharp
    public class UserDto
    {
        public Guid Id { get; set; }
        public string Email { get; set; }
        public List<string> Roles { get; set; }
    }
    ```
    
- **API.DTOs**
    
    ```csharp
    public class UserResponse
    {
        public string Email { get; set; }
        public List<string> Roles { get; set; }
    }
    ```
    

---

## **üìå –ö–∞–∫ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å DTO?**

–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç `UserDto` –∏–∑ **—Å–µ—Ä–≤–∏—Å–∞**, –æ–Ω –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –≤ **API-–º–æ–¥–µ–ª—å** (`UserResponse`).

```csharp
[HttpGet("{id}")]
public async Task<ActionResult<UserResponse>> GetUser(Guid id)
{
    var userDto = await _userService.GetUserByIdAsync(id);
    if (userDto == null)
        return NotFound();

    var response = new UserResponse
    {
        Email = userDto.Email,
        Roles = userDto.Roles
    };

    return Ok(response);
}
```

---

## **üìå –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ DTO?**

üîπ **–ò–∑–æ–ª—è—Ü–∏—è —Å–ª–æ—ë–≤** ‚Äì API –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏ **Application**.  
üîπ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äì –µ—Å–ª–∏ API –º–µ–Ω—è–µ—Ç—Å—è, **–Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É**.  
üîπ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äì —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ **–Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ API** (`PasswordHash`, `IsBlocked` –∏ —Ç. –¥.).

**üìå –ò—Ç–æ–≥:**  
üîπ **Application —Å–ª–æ–π** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Å–≤–æ–∏ DTO** (—Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π).  
üîπ **API —Å–ª–æ–π** ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ **—Å–≤–æ–∏ DTO** (—Å–∫—Ä—ã–≤–∞—è –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–ª—è).  
üöÄ **–≠—Ç–æ —á–∏—Å—Ç—ã–π –ø–æ–¥—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–¥–µ!**

## üîπ**–ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DTO?**

–ë—ã–≤–∞–µ—Ç, —á—Ç–æ **–æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ** –Ω—É–∂–Ω—ã –∏ –≤ **Application**, –∏ –≤ **API** —Å–ª–æ—è—Ö.

üëâ –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ **–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å** DTO. –ò—Ö –º–æ–∂–Ω–æ **–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:  
1Ô∏è‚É£**API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `PasswordHash` –∏–ª–∏ `IsBlocked`).  
2Ô∏è‚É£ **API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserName ‚Üí FullName`).  
3Ô∏è‚É£ **API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∞—Ç–∞ `2024-02-20T10:00:00Z` ‚Üí `20.02.2024 10:00`).

---

### **üìå –ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?**

‚úÖ –ï—Å–ª–∏ **API –∏ Application —Å–ª–æ–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**, –º–æ–∂–Ω–æ **—Å–æ–∑–¥–∞—Ç—å –æ–±—â–∏–µ DTO** –≤ **Application.DTOs**.

```csharp
namespace Application.DTOs
{
    public class UserDto
    {
        public Guid Id { get; set; }
        public string Email { get; set; }
        public List<string> Roles { get; set; }
    }
}
```

üîπ –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ **API** –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `UserDto` **–∏–∑ Application** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

```csharp
[HttpGet("{id}")]
public async Task<ActionResult<UserDto>> GetUser(Guid id)
{
    var user = await _userService.GetUserByIdAsync(id);
    if (user == null) return NotFound();
    return Ok(user); // –ò—Å–ø–æ–ª—å–∑—É–µ–º DTO –∏–∑ Application
}
```

---

### **üìå –ö–æ–≥–¥–∞ –ª—É—á—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å DTO?**

‚ùå **–ï—Å–ª–∏ API –∏ Application –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ-—Ä–∞–∑–Ω–æ–º—É**, —Ç–æ –ª—É—á—à–µ —Å–æ–∑–¥–∞—Ç—å **–æ—Ç–¥–µ–ª—å–Ω—ã–µ DTO**.

**–ü—Ä–∏–º–µ—Ä**:

- –í **Application** –Ω—É–∂–µ–Ω `UserDto`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç `PasswordHash`, `CreatedAt`.
- –í **API** —ç—Ç–∏ –ø–æ–ª—è **–Ω–µ –Ω—É–∂–Ω—ã**, –∏ `Email` –¥–æ–ª–∂–µ–Ω –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `EmailAddress`.

–¢–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º **—Ä–∞–∑–Ω—ã–µ DTO** –≤ **Application –∏ API**.

```csharp
// DTO –≤ Application (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
namespace Application.DTOs
{
    public class UserDto
    {
        public Guid Id { get; set; }
        public string Email { get; set; }
        public string PasswordHash { get; set; } // –ù–µ –¥–æ–ª–∂–Ω–æ –ø–æ–ø–∞–¥–∞—Ç—å –≤ API
        public DateTime CreatedAt { get; set; }
        public List<string> Roles { get; set; }
    }
}

// DTO –≤ API (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
namespace API.DTOs
{
    public class UserResponse
    {
        public string EmailAddress { get; set; } // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏ –ø–æ–ª–µ
        public List<string> Roles { get; set; }
    }
}
```

üí° **API –ø–æ–ª—É—á–∞–µ—Ç `UserDto` –∏–∑ Application, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `UserResponse`**

```csharp
[HttpGet("{id}")]
public async Task<ActionResult<UserResponse>> GetUser(Guid id)
{
    var userDto = await _userService.GetUserByIdAsync(id);
    if (userDto == null) return NotFound();

    var response = new UserResponse
    {
        EmailAddress = userDto.Email, // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª–µ
        Roles = userDto.Roles
    };

    return Ok(response);
}
```

---

### **üìå –ò—Ç–æ–≥**

‚úÖ **–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DTO** –∏–∑ **Application**, –µ—Å–ª–∏ API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è.  
‚ùå **–õ—É—á—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å DTO**, –µ—Å–ª–∏ API –¥–æ–ª–∂–µ–Ω —Å–∫—Ä—ã–≤–∞—Ç—å, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

**–ù–∞ –ø—Ä–æ–¥–µ –æ–±—ã—á–Ω–æ –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.** üöÄ