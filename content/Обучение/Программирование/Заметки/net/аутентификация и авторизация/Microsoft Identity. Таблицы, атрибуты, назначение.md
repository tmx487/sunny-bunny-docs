## Index

- [[#üîπ **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã Microsoft Identity**|–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã Microsoft Identity]]
- [[#Microsoft Identity. Access –∏ refresh —Ç–æ–∫–µ–Ω—ã]]
- [[#üîπ **–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤?**|–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤?]]
- [[#–ü–æ—è—Å–Ω–µ–Ω–∏—è –æ `ReplacedByToken` ‚Äì –µ—Å–ª–∏ refresh-—Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, —Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–æ–≤—ã–π]]
- [[#–ü–æ—è—Å–Ω–µ–Ω–∏—è –æ public ApplicationUser User { get; set; }]]
- [[#–°—Ü–µ–Ω–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤]]
- [[#–ê —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–µ?]]

Microsoft Identity –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ä–æ–ª—è–º–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π. –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ **ASP.NET Core Identity** –≤–º–µ—Å—Ç–µ —Å **Entity Framework Core**, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

---

## üîπ **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã Microsoft Identity**

### 1Ô∏è‚É£ **AspNetUsers** (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

üìå **–•—Ä–∞–Ω–∏—Ç —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

| –ü–æ–ª–µ                     | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö     | –û–ø–∏—Å–∞–Ω–∏–µ                                                                      |
| ------------------------ | -------------- | ----------------------------------------------------------------------------- |
| **Id**                   | string (GUID)  | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                                         |
| **UserName**             | nvarchar(256)  | –õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                                                            |
| **NormalizedUserName**   | nvarchar(256)  | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–∏–Ω (–¥–ª—è –ø–æ–∏—Å–∫–∞)                                            |
| **Email**                | nvarchar(256)  | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                                                            |
| **NormalizedEmail**      | nvarchar(256)  | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π email                                                         |
| **EmailConfirmed**       | bit            | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ email                                                          |
| **PasswordHash**         | nvarchar(max)  | –•—ç—à –ø–∞—Ä–æ–ª—è                                                                    |
| **SecurityStamp**        | nvarchar(max)  | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è)                |
| **[[ConcurrencyStamp]]** | nvarchar(max)  | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö |
| **PhoneNumber**          | nvarchar(15)   | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞                                                                |
| **PhoneNumberConfirmed** | bit            | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞                                                 |
| **TwoFactorEnabled**     | bit            | –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è                                      |
| **LockoutEnd**           | datetimeoffset | –î–∞—Ç–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)                        |
| **LockoutEnabled**       | bit            | –†–∞–∑—Ä–µ—à–µ–Ω–∞ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                                          |
| **AccessFailedCount**    | int            | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞                                            |

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –•—Ä–∞–Ω–∏—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã
- –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω email –∏ —Ç. –¥.)
- –•—Ä–∞–Ω–∏—Ç –ø–∞—Ä–æ–ª—å (–≤ –≤–∏–¥–µ —Ö—ç—à–∞)

---

### 2Ô∏è‚É£ **AspNetRoles** (–†–æ–ª–∏)

üìå **–•—Ä–∞–Ω–∏—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Admin", "User", "Teacher")**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**Id**|string (GUID)|–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–æ–ª–∏|
|**Name**|nvarchar(256)|–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏|
|**NormalizedName**|nvarchar(256)|–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è (–¥–ª—è –ø–æ–∏—Å–∫–∞)|
|**ConcurrencyStamp**|nvarchar(max)|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–æ–ª–∏ (`Admin`, `User`, `Manager`, –∏ —Ç. –¥.)
- –ö–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–ª–µ–π

---

### 3Ô∏è‚É£ **AspNetUserRoles** (–°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π)

üìå **–°–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`AspNetUsers`) –∏ –∏—Ö —Ä–æ–ª–∏ (`AspNetRoles`)**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**UserId**|string (GUID)|ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è|
|**RoleId**|string (GUID)|ID —Ä–æ–ª–∏|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **UserId = "123"** –Ω–∞–∑–Ω–∞—á–µ–Ω –≤ —Ä–æ–ª—å **RoleId = "Admin"**, —Ç–æ –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

üìå **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**:

|UserId|RoleId|
|---|---|
|`123`|`1` (Admin)|
|`456`|`2` (User)|

---

### 4Ô∏è‚É£ **AspNetUserClaims** (–ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–ª–µ–π–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

üìå **–•—Ä–∞–Ω–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–∏–¥–µ claim'–æ–≤**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**Id**|int|–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID|
|**UserId**|string (GUID)|ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è|
|**ClaimType**|nvarchar(max)|–¢–∏–ø claim (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Department")|
|**ClaimValue**|nvarchar(max)|–ó–Ω–∞—á–µ–Ω–∏–µ claim (–Ω–∞–ø—Ä–∏–º–µ—Ä, "HR")|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ù–∞–ø—Ä–∏–º–µ—Ä, —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å **ClaimType = "Department", ClaimValue = "HR"**, —á—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

üìå **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**:

|UserId|ClaimType|ClaimValue|
|---|---|---|
|`123`|`Department`|`HR`|
|`123`|`Permission`|`CanDeleteUsers`|

---

### 5Ô∏è‚É£ **AspNetRoleClaims** (–ö–ª–µ–π–º—ã –¥–ª—è —Ä–æ–ª–µ–π)

üìå **–•—Ä–∞–Ω–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (claim'—ã) –¥–ª—è —Ä–æ–ª–µ–π**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**Id**|int|–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID|
|**RoleId**|string (GUID)|ID —Ä–æ–ª–∏|
|**ClaimType**|nvarchar(max)|–¢–∏–ø claim|
|**ClaimValue**|nvarchar(max)|–ó–Ω–∞—á–µ–Ω–∏–µ claim|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ù–∞–ø—Ä–∏–º–µ—Ä, —Ä–æ–ª—å `Admin` –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **ClaimType = "Permission", ClaimValue = "CanManageUsers"**, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ –∫–æ–¥–µ.

üìå **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**:

|RoleId|ClaimType|ClaimValue|
|---|---|---|
|`1` (Admin)|`Permission`|`CanManageUsers`|

---

### 6Ô∏è‚É£ **AspNetUserLogins** (–í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤—Ö–æ–¥–∞)

üìå **–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ Google, Facebook –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**LoginProvider**|nvarchar(128)|–ù–∞–ø—Ä–∏–º–µ—Ä, "Google"|
|**ProviderKey**|nvarchar(128)|–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Google|
|**ProviderDisplayName**|nvarchar(max)|–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞|
|**UserId**|string (GUID)|ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª —á–µ—Ä–µ–∑ Google, Identity —Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ `ProviderKey` –¥–ª—è —Å–≤—è–∑–∏ —Å –µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–æ–º.

üìå **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**:

|UserId|LoginProvider|ProviderKey|
|---|---|---|
|`123`|`Google`|`google-uid-456`|

---

### 7Ô∏è‚É£ **AspNetUserTokens** (–¢–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

üìå **–•—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç–∏**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|**UserId**|string (GUID)|ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è|
|**LoginProvider**|nvarchar(128)|–ù–∞–ø—Ä–∏–º–µ—Ä, "Google"|
|**Name**|nvarchar(128)|–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞|
|**Value**|nvarchar(max)|–°–∞–º —Ç–æ–∫–µ–Ω|

üîπ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?**

- –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å **reset password tokens** –∏–ª–∏ **OAuth-—Ç–æ–∫–µ–Ω—ã**.

üìå **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**:

|UserId|LoginProvider|Name|Value|
|---|---|---|---|
|`123`|`Google`|`AccessToken`|`some-token-value`|

---

## üîπ **–í—ã–≤–æ–¥**

Microsoft Identity –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏.

‚úÖ **AspNetUsers** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏  
‚úÖ **AspNetRoles** ‚Äî —Ä–æ–ª–∏  
‚úÖ **AspNetUserRoles** ‚Äî —Å–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π  
‚úÖ **AspNetUserClaims / AspNetRoleClaims** ‚Äî –¥–æ–ø. –ø—Ä–∞–≤–∞  
‚úÖ **AspNetUserLogins** ‚Äî –ª–æ–≥–∏–Ω—ã —á–µ—Ä–µ–∑ Google, Facebook  
‚úÖ **AspNetUserTokens** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è)

üöÄ **–≠—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é –ª–æ–≥–∏–∫—É!**

## Microsoft Identity. Access –∏ refresh —Ç–æ–∫–µ–Ω—ã

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é** –≤ Microsoft Identity **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å **access** –∏ **refresh** —Ç–æ–∫–µ–Ω–∞–º–∏.

### üîπ **–ß—Ç–æ –µ—Å—Ç—å –≤ Microsoft Identity?**

‚úÖ **Identity** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ä–æ–ª—è–º–∏ –∏ –∫–ª–µ–π–º–∞–º–∏.  
‚úÖ –ï—Å—Ç—å **AspNetUserTokens**, –Ω–æ –æ–Ω–∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤ (—ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –∏–ª–∏ OAuth).  
‚úÖ Identity **–Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º JWT-—Ç–æ–∫–µ–Ω–æ–≤** ‚Äì –æ–Ω –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –ø—Ä–∞–≤–∞.

---

## üîπ **–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤?**

–¢–µ–±–µ –Ω—É–∂–Ω–æ **—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–∑—ã–≤ refresh-—Ç–æ–∫–µ–Ω–æ–≤**.

### ‚úÖ **1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è access –∏ refresh —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ**

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ–º **access-—Ç–æ–∫–µ–Ω (JWT)** –∏ **refresh-—Ç–æ–∫–µ–Ω**:

```csharp
private JwtSecurityToken GenerateAccessToken(ApplicationUser user, List<Claim> claims)
{
    var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtSettings.Secret));
    var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

    var token = new JwtSecurityToken(
        issuer: _jwtSettings.Issuer,
        audience: _jwtSettings.Audience,
        claims: claims,
        expires: DateTime.UtcNow.AddMinutes(_jwtSettings.AccessTokenExpiration),
        signingCredentials: credentials
    );

    return token;
}

private string GenerateRefreshToken()
{
    return Convert.ToBase64String(RandomNumberGenerator.GetBytes(64));
}
```

üîπ **Access-—Ç–æ–∫–µ–Ω** –ø–æ–¥–ø–∏—Å–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ —Ä–æ–ª–∏ –∏ –∫–ª–µ–π–º—ã.  
üîπ **Refresh-—Ç–æ–∫–µ–Ω** ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î.

---

### ‚úÖ **2. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤**

–î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ **Entity Framework**:

```csharp
public class RefreshToken
{
    public int Id { get; set; }
    public string Token { get; set; }
    public string UserId { get; set; }
    public DateTime ExpiryDate { get; set; }
    public bool IsRevoked { get; set; }
    public string? ReplacedByToken { get; set; }
    public ApplicationUser User { get; set; }
}
```

üìå **–ß—Ç–æ –≤–∞–∂–Ω–æ?**

- `Token` ‚Äì —Å–∞–º refresh-—Ç–æ–∫–µ–Ω
- `ExpiryDate` ‚Äì —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
- `IsRevoked` ‚Äì –º–æ–∂–Ω–æ –ª–∏ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- `ReplacedByToken` ‚Äì –µ—Å–ª–∏ refresh-—Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, —Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–æ–≤—ã–π

üîπ **–ú–∏–≥—Ä–∞—Ü–∏—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```csharp
modelBuilder.Entity<RefreshToken>()
    .HasOne(rt => rt.User)
    .WithMany()
    .HasForeignKey(rt => rt.UserId)
    .OnDelete(DeleteBehavior.Cascade);
```

---

### ‚úÖ **3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–∞ –≤ –±–∞–∑–µ**

–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î:

```csharp
var refreshToken = new RefreshToken
{
    Token = GenerateRefreshToken(),
    UserId = user.Id,
    ExpiryDate = DateTime.UtcNow.AddDays(7)
};

await _context.RefreshTokens.AddAsync(refreshToken);
await _context.SaveChangesAsync();
```

---

### ‚úÖ **4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access-—Ç–æ–∫–µ–Ω–∞ –ø–æ refresh-—Ç–æ–∫–µ–Ω—É**

–ö–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç **access-—Ç–æ–∫–µ–Ω**, –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

#### **–ó–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞**

```http
POST /refresh-token
Content-Type: application/json

{
    "refreshToken": "sometokenvalue"
}
```

#### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**

```csharp
[HttpPost("refresh-token")]
public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)
{
    var refreshToken = await _context.RefreshTokens
        .FirstOrDefaultAsync(rt => rt.Token == request.RefreshToken);

    if (refreshToken == null || refreshToken.ExpiryDate < DateTime.UtcNow || refreshToken.IsRevoked)
        return Unauthorized("Invalid or expired refresh token");

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω
    var user = await _userManager.FindByIdAsync(refreshToken.UserId);
    var newAccessToken = GenerateAccessToken(user, await _userManager.GetClaimsAsync(user));

    return Ok(new
    {
        AccessToken = new JwtSecurityTokenHandler().WriteToken(newAccessToken),
        RefreshToken = refreshToken.Token // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω–æ–≤—ã–π
    });
}
```

üîπ **–ü—Ä–æ–≤–µ—Ä—è–µ–º**: refresh-—Ç–æ–∫–µ–Ω –µ—Å—Ç—å –≤ –ë–î, –Ω–µ –æ—Ç–æ–∑–≤–∞–Ω, –Ω–µ –∏—Å—Ç–µ–∫.  
üîπ **–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π access-—Ç–æ–∫–µ–Ω** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É.

---

### ‚úÖ **5. –û—Ç–∑—ã–≤ refresh-—Ç–æ–∫–µ–Ω–∞**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∑—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω:

```csharp
[HttpPost("revoke")]
public async Task<IActionResult> RevokeToken([FromBody] RevokeTokenRequest request)
{
    var refreshToken = await _context.RefreshTokens
        .FirstOrDefaultAsync(rt => rt.Token == request.RefreshToken);

    if (refreshToken == null)
        return NotFound("Token not found");

    refreshToken.IsRevoked = true;
    await _context.SaveChangesAsync();

    return Ok("Token revoked successfully");
}
```

üîπ **–ü–æ–º–µ—á–∞–µ–º refresh-—Ç–æ–∫–µ–Ω –∫–∞–∫ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã–π**.  
üîπ **–ö–ª–∏–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å access-—Ç–æ–∫–µ–Ω**.

---

## üîπ **–í—ã–≤–æ–¥**

**Microsoft Identity –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å access/refresh —Ç–æ–∫–µ–Ω–∞–º–∏ "–∏–∑ –∫–æ—Ä–æ–±–∫–∏", –Ω–æ –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å:**  
‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–æ–≤.  
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access-—Ç–æ–∫–µ–Ω–∞.  
‚úÖ –û—Ç–∑—ã–≤ refresh-—Ç–æ–∫–µ–Ω–∞.

üí° **–í–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã.**

### –ü–æ—è—Å–Ω–µ–Ω–∏—è –æ `ReplacedByToken` ‚Äì –µ—Å–ª–∏ refresh-—Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, —Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–æ–≤—ã–π

### üîπ **–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç `ReplacedByToken`?**

`ReplacedByToken` –Ω—É–∂–µ–Ω –¥–ª—è **—Ü–µ–ø–æ—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π refresh-—Ç–æ–∫–µ–Ω–æ–≤**, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫–æ–π —Ç–æ–∫–µ–Ω –±—ã–ª –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è **–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**, —Ç–∞–∫ –∫–∞–∫:

- –ú—ã –º–æ–∂–µ–º **–æ—Ç–æ–∑–≤–∞—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É** —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ –≤–∑–ª–æ–º.
- –ú–æ–∂–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å **–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ refresh-—Ç–æ–∫–µ–Ω–∞**.

---

## üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç `access-—Ç–æ–∫–µ–Ω`, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π `refresh-—Ç–æ–∫–µ–Ω`. –ú—ã:

1. **–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω**.
2. **–û—Ç–º–µ—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –∫–∞–∫ "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π"**.
3. **–°–≤—è–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º** —á–µ—Ä–µ–∑ `ReplacedByToken`.

---

## üîπ **–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã**

üìå **–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –ø–µ—Ä–≤—ã–π refresh-—Ç–æ–∫–µ–Ω:**

```json
{
    "Id": 1,
    "Token": "abc123",
    "UserId": "user1",
    "ExpiryDate": "2025-03-01",
    "IsRevoked": false,
    "ReplacedByToken": null
}
```

‚û° **–ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access-—Ç–æ–∫–µ–Ω–∞.**

üìå **–°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö:**

```json
{
    "Id": 2,
    "Token": "xyz789",
    "UserId": "user1",
    "ExpiryDate": "2025-03-07",
    "IsRevoked": false,
    "ReplacedByToken": null
},
{
    "Id": 1,
    "Token": "abc123",
    "UserId": "user1",
    "ExpiryDate": "2025-03-01",
    "IsRevoked": true,
    "ReplacedByToken": "xyz789"
}
```

üîπ –¢–µ–ø–µ—Ä—å `abc123` **–Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞**, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω **–∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `xyz789`**.

---

## üîπ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ**

–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω:

```csharp
[HttpPost("refresh-token")]
public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)
{
    var oldToken = await _context.RefreshTokens
        .FirstOrDefaultAsync(rt => rt.Token == request.RefreshToken);

    if (oldToken == null || oldToken.ExpiryDate < DateTime.UtcNow || oldToken.IsRevoked)
        return Unauthorized("Invalid or expired refresh token");

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω
    var newToken = new RefreshToken
    {
        Token = GenerateRefreshToken(),
        UserId = oldToken.UserId,
        ExpiryDate = DateTime.UtcNow.AddDays(7)
    };

    // –û—Ç–º–µ—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∏ —Å–≤—è–∑—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º
    oldToken.IsRevoked = true;
    oldToken.ReplacedByToken = newToken.Token;

    _context.RefreshTokens.Add(newToken);
    await _context.SaveChangesAsync();

    var user = await _userManager.FindByIdAsync(oldToken.UserId);
    var newAccessToken = GenerateAccessToken(user, await _userManager.GetClaimsAsync(user));

    return Ok(new
    {
        AccessToken = new JwtSecurityTokenHandler().WriteToken(newAccessToken),
        RefreshToken = newToken.Token
    });
}
```

---

## üîπ **–ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏?**

‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ refresh-—Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**.  
‚úÖ **–ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É —Ç–æ–∫–µ–Ω–æ–≤**, –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è.  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–∫—Ä–∞–¥–µ—Ç —Å—Ç–∞—Ä—ã–π refresh-—Ç–æ–∫–µ–Ω, –æ–Ω —É–∂–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å**.

üí° **–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å refresh-—Ç–æ–∫–µ–Ω–∞–º–∏ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π.** üöÄ


### –ü–æ—è—Å–Ω–µ–Ω–∏—è –æ public ApplicationUser User { get; set; }

### üîπ **–ó–∞—á–µ–º –≤ `RefreshToken` —Å–≤–æ–π—Å—Ç–≤–æ `User`?**

–°–≤–æ–π—Å—Ç–≤–æ

```csharp
public ApplicationUser User { get; set; }
```

–Ω—É–∂–Ω–æ –¥–ª—è **–Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞** –≤ Entity Framework, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ **–ª–µ–≥–∫–æ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç refresh-—Ç–æ–∫–µ–Ω**.

---

## üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

–í `RefreshToken` —É–∂–µ –µ—Å—Ç—å `UserId` (FK), –Ω–æ `User` –Ω—É–∂–µ–Ω –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ C#.

### **1Ô∏è‚É£ –ë–µ–∑ `User`**

–ï—Å–ª–∏ —É –Ω–∞—Å —Ç–æ–ª—å–∫–æ `UserId`, –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å:

```csharp
var refreshToken = await _context.RefreshTokens.FindAsync(tokenId);
var user = await _context.Users.FindAsync(refreshToken.UserId);
```

‚ö† **–ú–∏–Ω—É—Å:** –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–∞–∑–µ.

---

### **2Ô∏è‚É£ –° `User` (–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ)**

Entity Framework **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**, –µ—Å–ª–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `Include`:

```csharp
var refreshToken = await _context.RefreshTokens
    .Include(rt => rt.User)  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
    .FirstOrDefaultAsync(rt => rt.Token == token);
```

‚úÖ **–ü–ª—é—Å:** –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å, —É–¥–æ–±–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏.

---

## üîπ **–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ?**

–í `ApplicationDbContext` –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤—è–∑—å:

```csharp
modelBuilder.Entity<RefreshToken>()
    .HasOne(rt => rt.User)
    .WithMany()  // –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ refresh-—Ç–æ–∫–µ–Ω–æ–≤
    .HasForeignKey(rt => rt.UserId)
    .OnDelete(DeleteBehavior.Cascade);
```

üìå **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥?**

- –û–¥–∏–Ω `User` –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–º–Ω–æ–≥–æ** `RefreshToken`.
- –£–∫–∞–∑—ã–≤–∞–µ–º `UserId` –∫–∞–∫ –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á (`FK`).
- `OnDelete(DeleteBehavior.Cascade)` ‚Äì –µ—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—Å–µ –µ–≥–æ refresh-—Ç–æ–∫–µ–Ω—ã —É–¥–∞–ª—è—Ç—Å—è.

---

## üîπ **–ö–æ–≥–¥–∞ —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ?**

‚úî –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ refresh-—Ç–æ–∫–µ–Ω—É.  
‚úî –ü—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, —Å –∫–∞–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ–Ω –≤—Ö–æ–¥–∏–ª).  
‚úî –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–Ω–µ—Å–∫–æ–ª—å–∫–æ refresh-—Ç–æ–∫–µ–Ω–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤).

üí° **–í—ã–≤–æ–¥:** `User` ‚Äì —ç—Ç–æ —É–¥–æ–±–Ω–æ–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. üöÄ

# **–°—Ü–µ–Ω–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**

–¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—É–∂–¥–∞–µ—à—å, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω—é–∞–Ω—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç —É—á–µ—Å—Ç—å. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º —à–∞–≥–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –∏ —É–ª—É—á—à–∏–º –ø—Ä–æ—Ü–µ—Å—Å.

---

### **üîπ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**

1Ô∏è‚É£**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–∞–ª–∏–¥–µ–Ω –ª–∏ `refreshToken` (–Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Å—Ä–æ–∫, –Ω–µ –±—ã–ª –ª–∏ –æ—Ç–æ–∑–≤–∞–Ω)**

- –ï—Å–ª–∏ **–∏—Å—Ç—ë–∫ (`ExpiryDate < DateTime.UtcNow`)**, –≤—ã–±—Ä–æ—Å–∏—Ç—å `SecurityTokenException`.
- –ï—Å–ª–∏ **–æ—Ç–æ–∑–≤–∞–Ω (`IsRevoked == true`)**, –≤—ã–±—Ä–æ—Å–∏—Ç—å `SecurityTokenException`.
- –ï—Å–ª–∏ **—É–∂ ||–µ –±—ã–ª –∑–∞–º–µ–Ω—ë–Ω (`ReplacedByToken != null`)**, –∑–Ω–∞—á–∏—Ç, –æ–Ω —É–∂–µ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω ‚Üí –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.

2Ô∏è‚É£ **–ù–∞–π—Ç–∏ `refreshToken` –≤ –ë–î**

- –ï—Å–ª–∏ `refreshToken` –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –≤—ã–±—Ä–æ—Å–∏—Ç—å `UnauthorizedAccessException`.
- –ï—Å–ª–∏ `UserId` –∏–∑ `refreshToken` **–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç** —Å `UserId` –∏–∑ `accessToken`, –≤—ã–±—Ä–æ—Å–∏—Ç—å `UnauthorizedAccessException` (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–æ–≤).

3Ô∏è‚É£ **–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ `accessToken` –∏ `refreshToken`**

- `accessToken` ‚Üí —Å –Ω–æ–≤—ã–º —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏ (–æ–±—ã—á–Ω–æ 15-60 –º–∏–Ω).
- `refreshToken` ‚Üí —Å –Ω–æ–≤—ã–º `Guid`, —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏ –∏ –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

4Ô∏è‚É£ **–û–±–Ω–æ–≤–∏—Ç—å refresh-—Ç–æ–∫–µ–Ω –≤ –ë–î**

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `IsRevoked = true` –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.
- –ó–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π `refreshToken` –≤ –ë–î.
- –í `ReplacedByToken` —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –∑–∞–ø–∏—Å–∞—Ç—å `Id` –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π).

5Ô∏è‚É£ **–í–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–µ `accessToken` –∏ `refreshToken` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**

---

### **üìå –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**

```csharp
public async Task<TokenResponse> RefreshTokensAsync(string refreshTokenValue)
{
    var refreshToken = await authDbContext.RefreshTokens
        .FirstOrDefaultAsync(rt => rt.Token == refreshTokenValue);

    if (refreshToken == null || refreshToken.IsRevoked || refreshToken.ReplacedByToken != null)
        throw new UnauthorizedAccessException("Invalid refresh token");

    if (refreshToken.ExpiryDate < DateTime.UtcNow)
        throw new SecurityTokenException("Refresh token expired");

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
    var newAccessToken = GenerateAccessToken(refreshToken.UserId);
    var newRefreshToken = GenerateRefreshToken(refreshToken.UserId);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–π refresh-—Ç–æ–∫–µ–Ω
    refreshToken.IsRevoked = true;
    refreshToken.ReplacedByToken = newRefreshToken.Token;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω
    await authDbContext.RefreshTokens.AddAsync(newRefreshToken);
    await authDbContext.SaveChangesAsync();

    return new TokenResponse
    {
        AccessToken = newAccessToken,
        RefreshToken = newRefreshToken.Token
    };
}
```

---

### **üîπ –ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ –≤ —ç—Ç–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏?**

‚úî **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- `IsRevoked` ‚Üí –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω.
- `ReplacedByToken` ‚Üí –Ω–µ–ª—å–∑—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–≤–∞–∂–¥—ã.
- `UserId` –≤ `refreshToken` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `accessToken`.

‚úî **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**

- –ü–æ–ª–µ `ReplacedByToken` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å, –∫–∞–∫–æ–π —Ç–æ–∫–µ–Ω –∑–∞–º–µ–Ω–∏–ª —Å—Ç–∞—Ä—ã–π.

‚úî **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**

- –ú–∏–Ω–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î (`FirstOrDefaultAsync` + `AddAsync`).
- `SaveChangesAsync()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –≤ –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

### **üîπ –ò—Ç–æ–≥**

–¢–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π **–≤ —Ü–µ–ª–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏ –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –ª–æ–≥–∏—á–Ω–µ–µ.  
**–ì–ª–∞–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

- –ü—Ä–æ–≤–µ—Ä—è—Ç—å **–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å** `refreshToken` –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
- –ü–æ–º–µ—á–∞—Ç—å —Å—Ç–∞—Ä—ã–π `refreshToken` –∫–∞–∫ `IsRevoked = true`.
- –°–≤—è–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π `refreshToken` —á–µ—Ä–µ–∑ `ReplacedByToken`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SaveChangesAsync()` **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç **–∑–∞—â–∏—Ç–∏—Ç—å API** –æ—Ç –∞—Ç–∞–∫ –∏ –Ω–µ –¥–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `refreshToken`.

## –ê —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–µ?

–ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–π –ø–æ–¥—Ö–æ–¥**, –Ω–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –º–µ—Ä–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º, **—á—Ç–æ –¥–µ–ª–∞—é—Ç –∫—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏** –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `access` –∏ `refresh` —Ç–æ–∫–µ–Ω–æ–≤.

---

## **üîπ –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–æ–∫–µ–Ω—ã –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ?**

–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç **5 –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤**:

### **1Ô∏è‚É£ –•—Ä–∞–Ω–µ–Ω–∏–µ `refreshToken` –≤ Redis –∏–ª–∏ –ë–î**

- **Redis** (–∏–ª–∏ –¥—Ä—É–≥–æ–π in-memory –∫—ç—à) ‚Üí üî• **–±—ã—Å—Ç—Ä–æ, –Ω–æ —Ç–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞**.
- **–ë–î (PostgreSQL, SQL Server)** ‚Üí üõ° **–Ω–∞–¥–µ–∂–Ω–æ, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ**.

**–ö–∞–∫ –¥–µ–ª–∞—é—Ç –Ω–∞ –ø—Ä–æ–¥–µ?**

- –ï—Å–ª–∏ **–Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Å–æ–∫–∞—è** (–º–∏–ª–ª–∏–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é—Ç Redis.
- –ï—Å–ª–∏ **–Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–±–æ–ª—å—à–∞—è** ‚Üí —Ö—Ä–∞–Ω—è—Ç `refreshToken` –≤ –ë–î.

**–ü—Ä–∏–º–µ—Ä –≤ Redis:**

```csharp
await redisDb.StringSetAsync(refreshToken.Token, refreshToken.UserId, expiry);
```

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:

```csharp
await redisDb.KeyDeleteAsync(oldRefreshToken);
await redisDb.StringSetAsync(newRefreshToken.Token, newRefreshToken.UserId, expiry);
```

---

### **2Ô∏è‚É£ "One-time use" refresh-—Ç–æ–∫–µ–Ω—ã (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)**

–ù–∞ –ø—Ä–æ–¥–µ `refreshToken` **–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**:

- **–°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω —Å—Ä–∞–∑—É —É–¥–∞–ª—è–µ—Ç—Å—è –∏–ª–∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è `IsRevoked = true`**.
- **–ù–æ–≤—ã–π `refreshToken` —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `accessToken`**.
- **–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω** ‚Üí –æ–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

‚úÖ **–ü–ª—é—Å—ã:** –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞—Ç–∞–∫ —Ç–∏–ø–∞ "refresh token replay".  
‚ùå **–ú–∏–Ω—É—Å—ã:** –µ—Å–ª–∏ —é–∑–µ—Ä —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ä–∞–∑—É (–≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞), –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö —É–ø–∞–¥—ë—Ç.

---

### **3Ô∏è‚É£ Refresh-—Ç–æ–∫–µ–Ω—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É**

–ù–∞ –ø—Ä–æ–¥–µ `refreshToken` –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç –∫:

- üìç **IP-–∞–¥—Ä–µ—Å—É** (–µ—Å–ª–∏ —Ä–µ–∑–∫–æ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é).
- üì± **User-Agent (–±—Ä–∞—É–∑–µ—Ä—É/—É—Å—Ç—Ä–æ–π—Å—Ç–≤—É)** ‚Üí –∑–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ —Ç–æ–∫–µ–Ω–æ–≤.
- üîê **Device ID (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)**.

**–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –ë–î?**

```csharp
public class RefreshToken
{
    public string Token { get; set; }
    public string UserId { get; set; }
    public DateTime ExpiryDate { get; set; }
    public bool IsRevoked { get; set; }
    public string ReplacedByToken { get; set; }
    public string DeviceId { get; set; } // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    public string UserAgent { get; set; } // –ë—Ä–∞—É–∑–µ—Ä/–º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    public string IPAddress { get; set; } // –ü–æ—Å–ª–µ–¥–Ω–∏–π IP
}
```

–ö–æ–≥–¥–∞ —é–∑–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω:

- **–ï—Å–ª–∏ `DeviceId` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç** ‚Üí –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø. –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (2FA).
- **–ï—Å–ª–∏ `IP` –∏–ª–∏ `User-Agent` —Ä–µ–∑–∫–æ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å** ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å e-mail –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---

### **4Ô∏è‚É£ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤**

–ù–∞ –ø—Ä–æ–¥–µ —á–∞—Å—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–∞–∫—Ç–∏–≤–Ω—ã—Ö `refreshToken`** –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–ø—Ä–∏–º–µ—Ä:

- **–¢–æ–ª—å–∫–æ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ.
- –ï—Å–ª–∏ —é–∑–µ—Ä –ª–æ–≥–∏–Ω–∏—Ç—Å—è –Ω–∞ **4-–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ** ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è **—Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π `refreshToken`**.

–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:

```csharp
var activeTokens = await authDbContext.RefreshTokens
    .Where(rt => rt.UserId == userId && !rt.IsRevoked)
    .OrderBy(rt => rt.ExpiryDate)
    .ToListAsync();

if (activeTokens.Count >= 3)
{
    var oldestToken = activeTokens.First();
    oldestToken.IsRevoked = true;
    authDbContext.RefreshTokens.Update(oldestToken);
}
```

‚úÖ **–ü–ª—é—Å—ã:** –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∫—Ä–∞–ª–∏, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å **–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –º–Ω–æ–≥–æ —Å–µ—Å—Å–∏–π**.

---

### **5Ô∏è‚É£ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç**

–ù–∞ –ø—Ä–æ–¥–µ **–ª–æ–≥–∏—Ä—É—é—Ç** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:

- üìå `UserId`
- üìå `OldRefreshToken`
- üìå `NewRefreshToken`
- üìå `IP`
- üìå `User-Agent`
- üìå `–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`

–ï—Å–ª–∏ –≤–∏–¥–∏–º **–º–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å —Ä–∞–∑–Ω—ã—Ö IP –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è** ‚Üí **–±–ª–æ–∫–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç**.

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:

```
[INFO] 2025-02-20 12:34:56 | User: 12345 | RefreshToken updated | IP: 192.168.1.1 | User-Agent: Chrome
```

---

## **üîπ –ò—Ç–æ–≥: –∫–∞–∫ –¥–µ–ª–∞—é—Ç –Ω–∞ –ø—Ä–æ–¥–µ?**

|üîç –§–∏—á–∞|üè¢ –ú–∞–ª—ã–π –ø—Ä–æ–µ–∫—Ç (–¥–æ 10K —é–∑–µ—Ä–æ–≤)|üè¢ –ö—Ä—É–ø–Ω—ã–π –ø—Ä–æ–¥ (100K+ —é–∑–µ—Ä–æ–≤)|
|---|---|---|
|**–•—Ä–∞–Ω–µ–Ω–∏–µ `refreshToken`**|–ë–î (PostgreSQL, SQL Server)|Redis + –ë–î (–¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π)|
|**–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã**|–ú–æ–∂–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å|‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ|
|**–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É**|–ú–æ–∂–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å|‚úÖ `DeviceId`, `User-Agent`, `IP`|
|**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π**|–ú–æ–∂–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å|‚úÖ –ú–∞–∫—Å. 3-5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤|
|**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**|–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ|‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ|

---

## **üîπ –ò—Ç–æ–≥: —á—Ç–æ —Ç–µ–±–µ —Å—Ç–æ–∏—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å?**

–ï—Å–ª–∏ —É —Ç–µ–±—è **–Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç**, —Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ `refreshToken` –∏ `IsRevoked`**.  
‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ReplacedByToken`**, —á—Ç–æ–±—ã –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.  
‚úÖ **–£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏** (`IsRevoked = true`).  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `refreshToken`** (—Ö–æ—Ç—è –±—ã –±–∞–∑–æ–≤–æ).

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É**, –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å:  
üî• **–ü—Ä–∏–≤—è–∑–∫—É –∫ `DeviceId`, `User-Agent` –∏ `IP`**.  
üî• **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤** (–º–∞–∫—Å. 3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞).  
üî• **–•—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã**.

---

## **üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?**

–¢—ã —É–∂–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏! üòé  
–ö–∞–∫ —Ç–µ–±–µ —ç—Ç–æ—Ç –ø—Ä–æ–¥–∞–∫—à–Ω-–ø–æ–¥—Ö–æ–¥? –ì–æ—Ç–æ–≤–∞ –µ–≥–æ –≤–Ω–µ–¥—Ä—è—Ç—å? üòä

# Include –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ AspNetUsers –∏ AspNetUserRoles

–î–∞, –º–æ–∂–Ω–æ! –í **ASP.NET Core —Å Identity** —Ç—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Include()** –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É `AspNetUsers` –∏ `AspNetUserRoles`, –Ω–æ —Ç–∞–∫ –∫–∞–∫ `AspNetUserRoles` ‚Äî —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ **–º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º**, –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–º–µ–Ω—Ç–æ–≤.

---

## üìå **–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å Include() –º–µ–∂–¥—É `AspNetUsers` –∏ `AspNetUserRoles`?**

### **1Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç —Å `UserManager` (–±–µ–∑ Include)**

–ï—Å–ª–∏ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å **`UserManager<TUser>`**, —Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–±–µ–∑ —è–≤–Ω–æ–≥–æ `Include()`**:

```csharp
var user = await _userManager.FindByIdAsync(userId);
var roles = await _userManager.GetRolesAsync(user);
```

üîπ –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º —É–∂–µ –¥–µ–ª–∞–µ—Ç `JOIN` —Å `AspNetUserRoles`.

---

### **2Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç —Å `DbContext` –∏ `Include()`**

–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å **—Å–≤–æ–π `DbContext`**, —Ç—ã –º–æ–∂–µ—à—å –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ `Include()`.

```csharp
var userWithRoles = await _context.Users
    .Include(u => u.UserRoles)
    .ThenInclude(ur => ur.Role)
    .FirstOrDefaultAsync(u => u.Id == userId);
```

üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

- `Users.Include(u => u.UserRoles)`: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º **AspNetUserRoles**.
- `ThenInclude(ur => ur.Role)`: –∑–∞—Ç–µ–º **–ø–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ–ª–∏** –∏–∑ `AspNetRoles`.

---

### **3Ô∏è‚É£ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä `DbContext`**

–í —Ç–≤–æ—ë–º `ApplicationDbContext` –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞:

```csharp
public class ApplicationUser : IdentityUser
{
    public virtual ICollection<IdentityUserRole<string>> UserRoles { get; set; }
}

public class ApplicationDbContext : IdentityDbContext<ApplicationUser>
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options) { }
}
```

–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –¥–µ–ª–∞—Ç—å `Include()` –≤ `DbContext`:

```csharp
var usersWithRoles = await _context.Users
    .Include(u => u.UserRoles)
    .ThenInclude(ur => ur.Role)
    .ToListAsync();
```

---

## üìå **–ö–∞–∫ –ø—Ä–æ—â–µ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—è–º–∏?**

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Join()`:

```csharp
var usersWithRoles = from user in _context.Users
                     join userRole in _context.UserRoles on user.Id equals userRole.UserId
                     join role in _context.Roles on userRole.RoleId equals role.Id
                     select new { user.UserName, role.Name };
```

üîπ –≠—Ç–æ—Ç –∫–æ–¥ –¥–µ–ª–∞–µ—Ç **JOIN** –º–µ–∂–¥—É `AspNetUsers`, `AspNetUserRoles` –∏ `AspNetRoles`.

---

## üéØ **–í—ã–≤–æ–¥**

‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Include()**:

```csharp
_context.Users.Include(u => u.UserRoles).ThenInclude(ur => ur.Role)
```

‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserManager.GetRolesAsync(user)`**  
‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Join()` –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

–ï—Å–ª–∏ —É —Ç–µ–±—è —Å–ª–æ–∂–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–ª–∏ `Include()` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø–∏—à–∏, —Ä–∞–∑–±–µ—Ä—ë–º—Å—è! üöÄ