
`lock` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –∑–∞ —Ä–∞–∑** –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –±–ª–æ–∫ –∫–æ–¥–∞, –∑–∞–∫–ª—é—á—ë–Ω–Ω—ã–π –≤ `lock`.

–ü—Ä–∏–º–µ—Ä:

```csharp
private static readonly object locker = new object();

lock (locker)
{
    // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–¥–µ—Å—å –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
}
```

### üìå –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º:

`lock(obj)` ‚Äî —ç—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `Monitor.Enter(obj)` –∏ `Monitor.Exit(obj)`:

```csharp
Monitor.Enter(obj);
try
{
    // critical section
}
finally
{
    Monitor.Exit(obj);
}
```

### ‚úÖ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

- `obj` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Å—ã–ª–æ—á–Ω—ã–º —Ç–∏–ø–æ–º (`object`, –Ω–∞–ø—Ä–∏–º–µ—Ä). –ß–∞—â–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `private static readonly object locker = new object();`.
    
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ **–ø–æ –∑–Ω–∞—á–∏–º–æ–º—É —Ç–∏–ø—É (int, struct)** ‚Äî –æ—à–∏–±–∫–∞.
    
- –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –≤–æ—à—ë–ª –≤ `lock`, –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ **–∂–¥—É—Ç**, –ø–æ–∫–∞ –æ–Ω –≤—ã–π–¥–µ—Ç –∏–∑ –Ω–µ–≥–æ.
    
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã **–æ–±—â–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤** –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
    

---

## üöß –ß—Ç–æ –∑–∞—â–∏—â–∞—é—Ç —Å –ø–æ–º–æ—â—å—é `lock`?

- –°—á—ë—Ç—á–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `counter++`)
    
- –ö–æ–ª–ª–µ–∫—Ü–∏–∏ (—Å–ø–∏—Å–∫–∏, –æ—á–µ—Ä–µ–¥–∏)
    
- –ó–∞–ø–∏—Å—å/—á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    
- –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π/—Å–æ–∫–µ—Ç–∞–º–∏
    

---

## üîÅ –ü—Ä–∏–º–µ—Ä: –±–µ–∑ `lock` ‚Äî race condition

```csharp
int counter = 0;

void Increment()
{
    for (int i = 0; i < 1000; i++)
    {
        counter++; // –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–æ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –ø–æ—Ç–µ—Ä–∏
    }
}
```

---

## ‚úÖ –¢–æ –∂–µ —Å `lock`

```csharp
int counter = 0;
object locker = new object();

void Increment()
{
    for (int i = 0; i < 1000; i++)
    {
        lock (locker)
        {
            counter++; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ
        }
    }
}
```

### üîπ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω `obj` –≤ `lock (obj) {...}`?

–ü–∞—Ä–∞–º–µ—Ç—Ä `obj` ‚Äî —ç—Ç–æ **–æ–±—ä–µ–∫—Ç-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** (—á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞—é—Ç `locker`, `lockObj`, `syncRoot` –∏ —Ç.–¥.).

---

### ‚úÖ –ï–≥–æ –∑–∞–¥–∞—á–∞ ‚Äî –±—ã—Ç—å "–∫–ª—é—á–æ–º" –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏:

–ö–æ–≥–¥–∞ —Ç—ã –ø–∏—à–µ—à—å:

```csharp
lock(obj)
{
    // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
}
```

—Ç—ã –≥–æ–≤–æ—Ä–∏—à—å:

> "–ü–æ—Ç–æ–∫, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤–æ–π—Ç–∏ –≤ —ç—Ç–æ—Ç –±–ª–æ–∫, –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å **–º–æ–Ω–∏—Ç–æ—Ä** (–±–ª–æ–∫–∏—Ä–æ–≤–∫—É) –Ω–∞ –æ–±—ä–µ–∫—Ç `obj`. –ï—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –∑–∞—Ö–≤–∞—Ç–∏–ª –µ–≥–æ ‚Äî –ø–æ–¥–æ–∂–¥–∏."

---

### üìå –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ `object`, –∞ –Ω–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, `int` –∏–ª–∏ `string`?

- `obj` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Å—Å—ã–ª–æ—á–Ω—ã–º —Ç–∏–ø–æ–º** (`object`, `class` –∏ —Ç.–¥.).
    
- **–ó–Ω–∞—á–∏–º—ã–µ —Ç–∏–ø—ã (value types)** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `int`, `bool`) –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî –æ–Ω–∏ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ, –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ.
    
- –ù–µ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `string` –∫–∞–∫ `lock`-–æ–±—ä–µ–∫—Ç ‚Äî —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –ª–∏—Ç–µ—Ä–∞–ª—ã –∏–Ω—Ç–µ—Ä–Ω–∏—Ä–æ–≤–∞–Ω—ã –≤ CLR, –∏ —Ç—ã –º–æ–∂–µ—à—å —Å–ª—É—á–∞–π–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —á—É–∂–∏–º –∫–æ–¥–æ–º.
    

---

### ‚úÖ –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞:

```csharp
private static readonly object locker = new object();

lock (locker)
{
    // —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏
}
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, `locker` ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ **–º–µ—Ç–∫–∞** (—Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç), –ø–æ –∫–æ—Ç–æ—Ä–æ–π –ø–æ—Ç–æ–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–æ–¥—É –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—É.

# –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –æ–±—ä–µ–∫—Ç `lock` –±—ã–ª **–æ–±—â–∏–º** –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤, –∞ –Ω–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –≤ –∫–∞–∂–¥–æ–º

---

## ‚ùå –ü—Ä–∏–º–µ—Ä —Å –¥–≤—É–º—è —Ä–∞–∑–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ (`lock` –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç):

```csharp
using System;
using System.Threading;

class Program
{
    static void Main()
    {
        object lock1 = new object();
        object lock2 = new object();

        Thread t1 = new Thread(() => DoWork("Thread 1", lock1));
        Thread t2 = new Thread(() => DoWork("Thread 2", lock2));

        t1.Start();
        t2.Start();

        t1.Join();
        t2.Join();
    }

    static void DoWork(string name, object locker)
    {
        for (int i = 0; i < 3; i++)
        {
            lock (locker)
            {
                Console.WriteLine($"{name} enters critical section.");
                Thread.Sleep(500); // –∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
                Console.WriteLine($"{name} exits critical section.");
            }
        }
    }
}
```

### üîç –ß—Ç–æ –±—É–¥–µ—Ç?

**`lock1` –∏ `lock2` ‚Äî —ç—Ç–æ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞**, –∑–Ω–∞—á–∏—Ç **–ø–æ—Ç–æ–∫–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è**, –∏ –æ–±–∞ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

üëâ –¢–æ –µ—Å—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å—Ç—Ä–æ–∫–∏ –æ—Ç `Thread 1` –∏ `Thread 2` –º–æ–≥—É—Ç —á–µ—Ä–µ–¥–æ–≤–∞—Ç—å—Å—è, –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –∏ –¥–∞–∂–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä —Å –æ–¥–Ω–∏–º –æ–±—â–∏–º –æ–±—ä–µ–∫—Ç–æ–º (`lock` –†–ê–ë–û–¢–ê–ï–¢ –ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```csharp
using System;
using System.Threading;

class Program
{
    private static readonly object sharedLock = new object();

    static void Main()
    {
        Thread t1 = new Thread(() => DoWork("Thread 1"));
        Thread t2 = new Thread(() => DoWork("Thread 2"));

        t1.Start();
        t2.Start();

        t1.Join();
        t2.Join();
    }

    static void DoWork(string name)
    {
        for (int i = 0; i < 3; i++)
        {
            lock (sharedLock)
            {
                Console.WriteLine($"{name} enters critical section.");
                Thread.Sleep(500);
                Console.WriteLine($"{name} exits critical section.");
            }
        }
    }
}
```

### üîç –ß—Ç–æ –±—É–¥–µ—Ç?

–¢–µ–ø–µ—Ä—å **–æ–±–∞ –ø–æ—Ç–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ `sharedLock`**, –∑–Ω–∞—á–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –∑–∞—Ö–æ–¥–∏—Ç –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –∑–∞ —Ä–∞–∑. –í—ã–≤–æ–¥ –±—É–¥–µ—Ç —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:

```
Thread 1 enters critical section.
Thread 1 exits critical section.
Thread 2 enters critical section.
Thread 2 exits critical section.
...
```

–í–æ—Ç –ø–æ—à–∞–≥–æ–≤–∞—è **–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞**, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∞—è, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `lock` —Å –æ–±—â–∏–º –æ–±—ä–µ–∫—Ç–æ–º.

---

## üîß –ö–æ–¥ (–¥–ª—è –ø—Ä–∏–º–µ—Ä–∞):

```csharp
private static readonly object sharedLock = new object();

static void Main()
{
    Thread t1 = new Thread(() => DoWork("T1"));
    Thread t2 = new Thread(() => DoWork("T2"));

    t1.Start();
    t2.Start();

    t1.Join();
    t2.Join();
}

static void DoWork(string name)
{
    for (int i = 0; i < 2; i++)
    {
        lock (sharedLock)
        {
            Console.WriteLine($"{name} enters");
            Thread.Sleep(500); // –∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
            Console.WriteLine($"{name} exits");
        }
    }
}
```

---

## üìà –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ 0.5 —Å–µ–∫—É–Ω–¥—ã)

|–í—Ä–µ–º—è (—Å–µ–∫)|–ü–æ—Ç–æ–∫ T1|–ü–æ—Ç–æ–∫ T2|
|---|---|---|
|0.0|`lock` –∑–∞—Ö–≤–∞—á–µ–Ω|–∂–¥–µ—Ç `sharedLock`|
|0.5|–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏|–∂–¥–µ—Ç|
|1.0|`lock` –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω|`lock` –∑–∞—Ö–≤–∞—á–µ–Ω|
|1.5|–∂–¥–µ—Ç|–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏|
|2.0|`lock` –∑–∞—Ö–≤–∞—á–µ–Ω|–∂–¥–µ—Ç|
|2.5|–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏|–∂–¥–µ—Ç|
|3.0|`lock` –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω|`lock` –∑–∞—Ö–≤–∞—á–µ–Ω|
|3.5|–∂–¥–µ—Ç|–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏|
|4.0|–∑–∞–≤–µ—Ä—à–µ–Ω|–∑–∞–≤–µ—Ä—à–µ–Ω|

---

## üîÅ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **T1 –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ä–∞–∑—É –≤—Ö–æ–¥–∏—Ç –≤ `lock`**, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–≤–æ–±–æ–¥–µ–Ω.
    
2. **T2 –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ –∂–¥–µ—Ç**, –ø–æ–∫–∞ T1 –≤—ã–π–¥–µ—Ç –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏.
    
3. –ö–∞–∫ —Ç–æ–ª—å–∫–æ T1 –æ—Å–≤–æ–±–æ–¥–∏—Ç `sharedLock`, **T2 –∑–∞—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä—å**.
    
4. –≠—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Ç.–∫. —Ü–∏–∫–ª –ø–æ 2 –∏—Ç–µ—Ä–∞—Ü–∏–∏.
    

---

## ‚òùÔ∏è –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥–µ—Ç:

```
T1 enters
T1 exits
T2 enters
T2 exits
T1 enters
T1 exits
T2 enters
T2 exits
```

> –ü–æ—Ä—è–¥–æ–∫ T1‚ÄìT2 –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–º, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–° —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç T2 ‚Äî –Ω–æ **–ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ `lock` –Ω–µ –±—É–¥–µ—Ç –Ω–∏–∫–æ–≥–¥–∞**.
