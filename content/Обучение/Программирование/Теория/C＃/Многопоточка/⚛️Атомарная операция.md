## üí° –ß—Ç–æ –∑–Ω–∞—á–∏—Ç _–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è_?

**–ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** ‚Äî —ç—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è **–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –Ω–µ–¥–µ–ª–∏–º–æ**, —Ç.–µ.:

- –û–Ω–∞ **–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–∞** –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º.
    
- –ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç ¬´–≤–ª–µ–∑—Ç—å¬ª –≤ —Å–µ—Ä–µ–¥–∏–Ω—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–∫–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
    

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –∫–ª–∞–¥—ë—à—å –¥–µ–Ω—å–≥–∏ –≤ —Å–µ–π—Ñ. –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∞—Ç–æ–º–∞—Ä–Ω–∞, —Ç–æ —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–ª —Å–µ–π—Ñ –∏ –∑–∞–±—Ä–∞–ª –∫–ª—é—á –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π —Å–º–æ–≥ –±—ã –≤–º–µ—à–∞—Ç—å—Å—è.

---

## üß® –ü—Ä–∏–º–µ—Ä –ù–ï–∞—Ç–æ–º–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

```csharp
counter++;
```

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –æ–Ω–∞ –≤–∫–ª—é—á–∞–µ—Ç **—Ç—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è**:

1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `counter` –∏–∑ –ø–∞–º—è—Ç–∏.
    
2. –£–≤–µ–ª–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ.
    
3. –ó–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–∞–º—è—Ç—å.

```csharp
// count++
int temp = count;
temp = temp + 1;
count = temp;
```

–ï—Å–ª–∏ –≤ —ç—Ç–æ –≤—Ä–µ–º—è –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –¥–µ–ª–∞–µ—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ, –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è. –ü–æ—ç—Ç–æ–º—É `counter++` ‚Äî **–Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞**.

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä—ã **–∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** –≤ .NET

.NET –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å **–∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**.

### 1. `Interlocked.Increment(ref counter)`

```csharp
Interlocked.Increment(ref counter);
```

‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `counter` –Ω–∞ 1.

---

### 2. `Interlocked.Decrement(ref counter)`

‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ 1.

---

### 3. `Interlocked.Add(ref counter, value)`

‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–∏–±–∞–≤–ª—è–µ—Ç `value` –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `counter`.

---

### 4. `Interlocked.Exchange(ref location, newValue)`

‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ **–∑–∞–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ** –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.

---

### 5. `Interlocked.CompareExchange(ref location, newValue, comparand)`

‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, **–µ—Å–ª–∏ –æ–Ω–∞ —Ä–∞–≤–Ω–∞** `comparand`. –û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `location`

---

## ‚úç –ü—Ä–∏–º–µ—Ä

```csharp
using System;
using System.Threading;

class Program
{
    static int counter = 0;

    static void Main()
    {
        Thread t1 = new Thread(Increment);
        Thread t2 = new Thread(Increment);

        t1.Start();
        t2.Start();

        t1.Join();
        t2.Join();

        Console.WriteLine("Final counter: " + counter); // –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç 2000000
    }

    static void Increment()
    {
        for (int i = 0; i < 1000000; i++)
        {
            Interlocked.Increment(ref counter);
        }
    }
}
```

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ `Interlocked.Increment` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –∏ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö **–±–µ–∑ `lock`**.

---

–•–æ—á–µ—à—å, –¥–∞–º –∑–∞–¥–∞–Ω–∏–µ, –≥–¥–µ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `lock`, `Interlocked` –∏–ª–∏ –Ω–∏—á–µ–≥–æ?