**Circuit Breaker** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å) ‚Äî —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–±–æ–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö. –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–º –∞–≤—Ç–æ–º–∞—Ç–æ–º ‚Äî –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫, –æ–Ω "—Ä–∞–∑–º—ã–∫–∞–µ—Ç —Ü–µ–ø—å" –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã –∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É.

## –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∏—Ç—É–∞—Ü–∏—é:

- –¢–≤–æ–π —Å–µ—Ä–≤–∏—Å –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π API
- API –Ω–∞—á–∏–Ω–∞–µ—Ç "—Ç–æ—Ä–º–æ–∑–∏—Ç—å" –∏–ª–∏ –ø–∞–¥–∞—Ç—å
- –í—Å–µ —Ç–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –≤–∏—Å—è—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- **–ö–∞—Å–∫–∞–¥–Ω—ã–π —Å–±–æ–π** ‚Äî –æ–¥–∏–Ω —É–ø–∞–≤—à–∏–π —Å–µ—Ä–≤–∏—Å "—Ä–æ–Ω—è–µ—Ç" –≤—Å—é —Å–∏—Å—Ç–µ–º—É

**Circuit Breaker** —Ä–µ—à–∞–µ—Ç —ç—Ç–æ —Ç–∞–∫:

- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ ‚Äî "—Ä–∞–∑–º—ã–∫–∞–µ—Ç —Ü–µ–ø—å" (–ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–ª–∏ –æ—à–∏–±–∫–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ "–ø–æ—á–∏–Ω–∏–ª—Å—è" –ª–∏ —Å–µ—Ä–≤–∏—Å

## –°–æ—Å—Ç–æ—è–Ω–∏—è Circuit Breaker

```
    [–£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã]
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ CLOSED  ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
    ‚îÇ (—Ä–∞–±–æ—Ç–∞)‚îÇ      
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì [–ú–Ω–æ–≥–æ –æ—à–∏–±–æ–∫]
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  OPEN   ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ –ó–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è  
    ‚îÇ(—Å–ª–æ–º–∞–Ω–æ)‚îÇ      –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì [–¢–∞–π–º–∞—É—Ç –∏—Å—Ç–µ–∫]
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇHALF-OPEN‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ –ü—Ä–æ–±—É–µ–º –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å  
    ‚îÇ (—Ç–µ—Å—Ç)  ‚îÇ      
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
    [–£—Å–ø–µ—Ö] ‚Üí CLOSED
    [–û—à–∏–±–∫–∞] ‚Üí OPEN
```

## –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Circuit Breaker

```cs
public class CircuitBreaker
{
    private readonly int _failureThreshold;
    private readonly TimeSpan _timeout;
    private readonly ILogger _logger;
    
    private int _failureCount = 0;
    private DateTime _lastFailureTime = DateTime.MinValue;
    private CircuitBreakerState _state = CircuitBreakerState.Closed;
    private readonly object _lock = new object();
    
    public CircuitBreaker(int failureThreshold, TimeSpan timeout, ILogger logger)
    {
        _failureThreshold = failureThreshold;
        _timeout = timeout;
        _logger = logger;
    }
    
    public async Task<T> ExecuteAsync<T>(Func<Task<T>> operation, Func<Task<T>> fallback = null)
    {
        lock (_lock)
        {
            if (_state == CircuitBreakerState.Open)
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Ä–∞ –ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                if (DateTime.UtcNow - _lastFailureTime > _timeout)
                {
                    _state = CircuitBreakerState.HalfOpen;
                    _logger.LogInformation("Circuit breaker state changed to HalfOpen");
                }
                else
                {
                    _logger.LogWarning("Circuit breaker is OPEN, blocking request");
                    
                    if (fallback != null)
                        return await fallback();
                        
                    throw new CircuitBreakerOpenException("Circuit breaker is OPEN");
                }
            }
        }
        
        try
        {
            var result = await operation();
            
            // –£—Å–ø–µ—Ö - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            OnSuccess();
            return result;
        }
        catch (Exception ex)
        {
            OnFailure(ex);
            throw;
        }
    }
    
    private void OnSuccess()
    {
        lock (_lock)
        {
            _failureCount = 0;
            _state = CircuitBreakerState.Closed;
            _logger.LogDebug("Circuit breaker reset to CLOSED state");
        }
    }
    
    private void OnFailure(Exception ex)
    {
        lock (_lock)
        {
            _failureCount++;
            _lastFailureTime = DateTime.UtcNow;
            
            _logger.LogWarning("Circuit breaker failure #{FailureCount}: {Error}", 
                _failureCount, ex.Message);
            
            if (_failureCount >= _failureThreshold)
            {
                _state = CircuitBreakerState.Open;
                _logger.LogError("Circuit breaker OPENED after {FailureCount} failures", _failureCount);
            }
        }
    }
    
    public CircuitBreakerState CurrentState
    {
        get
        {
            lock (_lock)
            {
                return _state;
            }
        }
    }
}

public enum CircuitBreakerState
{
    Closed,   // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
    Open,     // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã
    HalfOpen  // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
}

public class CircuitBreakerOpenException : Exception
{
    public CircuitBreakerOpenException(string message) : base(message) { }
}
```

## –ü—Ä–æ–¥–∞–∫—à–Ω –ø—Ä–∏–º–µ—Ä: HTTP API —Å Circuit Breaker

```cs
public interface IExternalApiService
{
    Task<UserData> GetUserAsync(int userId);
    Task<OrderData> GetOrderAsync(int orderId);
}

public class ExternalApiService : IExternalApiService
{
    private readonly HttpClient _httpClient;
    private readonly CircuitBreaker _circuitBreaker;
    private readonly IMemoryCache _cache;
    private readonly ILogger<ExternalApiService> _logger;
    
    public ExternalApiService(
        HttpClient httpClient, 
        IMemoryCache cache,
        ILogger<ExternalApiService> logger)
    {
        _httpClient = httpClient;
        _cache = cache;
        _logger = logger;
        
        // Circuit Breaker: 5 –æ—à–∏–±–æ–∫ –∑–∞ 30 —Å–µ–∫—É–Ω–¥ = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 1 –º–∏–Ω—É—Ç—É
        _circuitBreaker = new CircuitBreaker(
            failureThreshold: 5,
            timeout: TimeSpan.FromMinutes(1),
            logger);
    }
    
    public async Task<UserData> GetUserAsync(int userId)
    {
        return await _circuitBreaker.ExecuteAsync(
            // –û—Å–Ω–æ–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
            operation: async () =>
            {
                _logger.LogDebug("Calling external API for user {UserId}", userId);
                
                var response = await _httpClient.GetAsync($"api/users/{userId}");
                response.EnsureSuccessStatusCode();
                
                var json = await response.Content.ReadAsStringAsync();
                var userData = JsonSerializer.Deserialize<UserData>(json);
                
                // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                _cache.Set($"user:{userId}", userData, TimeSpan.FromMinutes(10));
                
                return userData;
            },
            // Fallback - —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ circuit breaker –æ—Ç–∫—Ä—ã—Ç
            fallback: async () =>
            {
                _logger.LogWarning("Circuit breaker is OPEN, trying to get user {UserId} from cache", userId);
                
                // –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∫—ç—à–∞
                if (_cache.TryGetValue($"user:{userId}", out UserData cachedUser))
                {
                    _logger.LogInformation("Returned cached user data for {UserId}", userId);
                    return cachedUser;
                }
                
                // –ï—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                _logger.LogWarning("No cached data for user {UserId}, returning default", userId);
                return new UserData 
                { 
                    Id = userId, 
                    Name = "Unknown User", 
                    Email = "unavailable@service.down",
                    IsFromCache = true 
                };
            });
    }
    
    public async Task<OrderData> GetOrderAsync(int orderId)
    {
        return await _circuitBreaker.ExecuteAsync(
            operation: async () =>
            {
                var response = await _httpClient.GetAsync($"api/orders/{orderId}");
                response.EnsureSuccessStatusCode();
                
                var json = await response.Content.ReadAsStringAsync();
                return JsonSerializer.Deserialize<OrderData>(json);
            },
            fallback: async () =>
            {
                // –î–ª—è –∑–∞–∫–∞–∑–æ–≤ fallback –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–º
                _logger.LogError("Cannot get order {OrderId} - external service is down", orderId);
                throw new ServiceUnavailableException($"Order service is temporarily unavailable");
            });
    }
}

public class UserData
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public bool IsFromCache { get; set; } = false;
}

public class OrderData
{
    public int Id { get; set; }
    public decimal Amount { get; set; }
    public string Status { get; set; }
}

public class ServiceUnavailableException : Exception
{
    public ServiceUnavailableException(string message) : base(message) { }
}
```

## Circuit Breaker —Å Polly (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥)

**Polly** ‚Äî —ç—Ç–æ –ø–æ–ø—É–ª—è—Ä–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è .NET, –∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é Circuit Breaker:

```cs
public class PollyExternalApiService : IExternalApiService
{
    private readonly HttpClient _httpClient;
    private readonly IAsyncPolicy<HttpResponseMessage> _circuitBreakerPolicy;
    private readonly IMemoryCache _cache;
    private readonly ILogger<PollyExternalApiService> _logger;
    
    public PollyExternalApiService(
        HttpClient httpClient,
        IMemoryCache cache,
        ILogger<PollyExternalApiService> logger)
    {
        _httpClient = httpClient;
        _cache = cache;
        _logger = logger;
        
        // –°–æ–∑–¥–∞–µ–º Circuit Breaker –ø–æ–ª–∏—Ç–∏–∫—É —Å Polly
        _circuitBreakerPolicy = Policy
            .HandleResult<HttpResponseMessage>(r => !r.IsSuccessStatusCode)
            .Or<HttpRequestException>()
            .Or<TaskCanceledException>() // Timeout
            .CircuitBreakerAsync(
                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
                handledEventsAllowedBeforeBreaking: 5,
                // –í—Ä–µ–º—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º circuit breaker
                durationOfBreak: TimeSpan.FromMinutes(1),
                // Callback –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                onBreak: (exception, duration) =>
                {
                    _logger.LogError("Circuit breaker OPENED for {Duration}s due to: {Exception}",
                        duration.TotalSeconds, exception.Exception?.Message ?? exception.Result?.StatusCode.ToString());
                },
                // Callback –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                onReset: () =>
                {
                    _logger.LogInformation("Circuit breaker CLOSED - service is healthy again");
                },
                // Callback –ø—Ä–∏ –ø–æ–ª–æ–≤–∏–Ω–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
                onHalfOpen: () =>
                {
                    _logger.LogInformation("Circuit breaker HALF-OPEN - testing service health");
                });
    }
    
    public async Task<UserData> GetUserAsync(int userId)
    {
        try
        {
            var response = await _circuitBreakerPolicy.ExecuteAsync(async () =>
            {
                _logger.LogDebug("Calling external API for user {UserId}", userId);
                return await _httpClient.GetAsync($"api/users/{userId}");
            });
            
            var json = await response.Content.ReadAsStringAsync();
            var userData = JsonSerializer.Deserialize<UserData>(json);
            
            // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            _cache.Set($"user:{userId}", userData, TimeSpan.FromMinutes(10));
            
            return userData;
        }
        catch (CircuitBreakerOpenException)
        {
            _logger.LogWarning("Circuit breaker is OPEN for user {UserId}, using fallback", userId);
            
            // Fallback logic
            if (_cache.TryGetValue($"user:{userId}", out UserData cachedUser))
            {
                return cachedUser;
            }
            
            return new UserData 
            { 
                Id = userId, 
                Name = "Service Unavailable", 
                Email = "service@unavailable.com",
                IsFromCache = true 
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting user {UserId}", userId);
            throw;
        }
    }
    
    public async Task<OrderData> GetOrderAsync(int orderId)
    {
        try
        {
            var response = await _circuitBreakerPolicy.ExecuteAsync(async () =>
            {
                return await _httpClient.GetAsync($"api/orders/{orderId}");
            });
            
            var json = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<OrderData>(json);
        }
        catch (CircuitBreakerOpenException)
        {
            _logger.LogError("Cannot get order {OrderId} - circuit breaker is OPEN", orderId);
            throw new ServiceUnavailableException("Order service is temporarily unavailable");
        }
    }
}
```

## –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Circuit Breaker —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏

### 1. Circuit Breaker + Retry + Timeout

```cs
public class ResilientApiService : IExternalApiService
{
    private readonly HttpClient _httpClient;
    private readonly IAsyncPolicy _resilientPolicy;
    private readonly ILogger<ResilientApiService> _logger;
    
    public ResilientApiService(HttpClient httpClient, ILogger<ResilientApiService> logger)
    {
        _httpClient = httpClient;
        _logger = logger;
        
        // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–∏—Ç–∏–∫
        var retryPolicy = Policy
            .Handle<HttpRequestException>()
            .Or<TaskCanceledException>()
            .WaitAndRetryAsync(
                retryCount: 3,
                sleepDurationProvider: retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                onRetry: (outcome, timespan, retryCount, context) =>
                {
                    _logger.LogWarning("Retry {RetryCount} after {Delay}ms: {Exception}",
                        retryCount, timespan.TotalMilliseconds, outcome.Exception?.Message);
                });
        
        var circuitBreakerPolicy = Policy
            .Handle<HttpRequestException>()
            .Or<TaskCanceledException>()
            .CircuitBreakerAsync(
                handledEventsAllowedBeforeBreaking: 3,
                durationOfBreak: TimeSpan.FromSeconds(30),
                onBreak: (exception, duration) =>
                    _logger.LogError("Circuit breaker opened for {Duration}s", duration.TotalSeconds),
                onReset: () => _logger.LogInformation("Circuit breaker closed"));
        
        var timeoutPolicy = Policy
            .TimeoutAsync(TimeSpan.FromSeconds(10));
        
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏: Timeout -> CircuitBreaker -> Retry
        _resilientPolicy = Policy.WrapAsync(timeoutPolicy, circuitBreakerPolicy, retryPolicy);
    }
    
    public async Task<UserData> GetUserAsync(int userId)
    {
        return await _resilientPolicy.ExecuteAsync(async () =>
        {
            _logger.LogDebug("Calling external API for user {UserId}", userId);
            
            var response = await _httpClient.GetAsync($"api/users/{userId}");
            response.EnsureSuccessStatusCode();
            
            var json = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<UserData>(json);
        });
    }
}
```

### 2. Circuit Breaker —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏

```cs
public class MonitoredCircuitBreakerService : IExternalApiService
{
    private readonly HttpClient _httpClient;
    private readonly IAsyncPolicy _policy;
    private readonly IMetrics _metrics;
    private readonly ILogger<MonitoredCircuitBreakerService> _logger;
    
    public MonitoredCircuitBreakerService(
        HttpClient httpClient, 
        IMetrics metrics,
        ILogger<MonitoredCircuitBreakerService> logger)
    {
        _httpClient = httpClient;
        _metrics = metrics;
        _logger = logger;
        
        _policy = Policy
            .Handle<HttpRequestException>()
            .Or<TaskCanceledException>()
            .CircuitBreakerAsync(
                handledEventsAllowedBeforeBreaking: 5,
                durationOfBreak: TimeSpan.FromMinutes(1),
                onBreak: (exception, duration) =>
                {
                    _metrics.IncrementCounter("circuit_breaker.opened");
                    _metrics.SetGauge("circuit_breaker.state", 1); // 1 = Open
                    
                    _logger.LogError("Circuit breaker opened: {Exception}", exception.Exception?.Message);
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                    NotifyMonitoring("Circuit breaker opened", exception.Exception);
                },
                onReset: () =>
                {
                    _metrics.IncrementCounter("circuit_breaker.closed");
                    _metrics.SetGauge("circuit_breaker.state", 0); // 0 = Closed
                    
                    _logger.LogInformation("Circuit breaker closed");
                    NotifyMonitoring("Circuit breaker closed", null);
                },
                onHalfOpen: () =>
                {
                    _metrics.SetGauge("circuit_breaker.state", 0.5); // 0.5 = HalfOpen
                    _logger.LogInformation("Circuit breaker half-open");
                });
    }
    
    public async Task<UserData> GetUserAsync(int userId)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            return await _policy.ExecuteAsync(async () =>
            {
                var response = await _httpClient.GetAsync($"api/users/{userId}");
                response.EnsureSuccessStatusCode();
                
                var json = await response.Content.ReadAsStringAsync();
                return JsonSerializer.Deserialize<UserData>(json);
            });
        }
        catch (CircuitBreakerOpenException)
        {
            _metrics.IncrementCounter("api.requests.blocked");
            throw new ServiceUnavailableException("Service temporarily unavailable");
        }
        catch (Exception ex)
        {
            _metrics.IncrementCounter("api.requests.failed");
            throw;
        }
        finally
        {
            stopwatch.Stop();
            _metrics.RecordValue("api.request.duration", stopwatch.ElapsedMilliseconds);
        }
    }
    
    private void NotifyMonitoring(string message, Exception exception)
    {
        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Slack, Teams, PagerDuty, etc.)
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã
    }
}
```

## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ DI —Å Polly

```cs
public void ConfigureServices(IServiceCollection services)
{
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º HttpClient —Å Circuit Breaker
    services.AddHttpClient<IExternalApiService, PollyExternalApiService>(client =>
    {
        client.BaseAddress = new Uri("https://external-api.com/");
        client.Timeout = TimeSpan.FromSeconds(30);
    })
    .AddPolicyHandler(GetCircuitBreakerPolicy())
    .AddPolicyHandler(GetRetryPolicy())
    .AddPolicyHandler(GetTimeoutPolicy());
    
    services.AddMemoryCache();
}

private static IAsyncPolicy<HttpResponseMessage> GetCircuitBreakerPolicy()
{
    return HttpPolicyExtensions
        .HandleTransientHttpError()
        .CircuitBreakerAsync(
            handledEventsAllowedBeforeBreaking: 5,
            durationOfBreak: TimeSpan.FromMinutes(1),
            onBreak: (result, duration) =>
            {
                Console.WriteLine($"Circuit opened for {duration}");
            },
            onReset: () =>
            {
                Console.WriteLine("Circuit closed");
            });
}

private static IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
{
    return HttpPolicyExtensions
        .HandleTransientHttpError()
        .WaitAndRetryAsync(
            retryCount: 3,
            sleepDurationProvider: retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));
}

private static IAsyncPolicy<HttpResponseMessage> GetTimeoutPolicy()
{
    return Policy.TimeoutAsync<HttpResponseMessage>(TimeSpan.FromSeconds(10));
}
```

## Health Check —Å Circuit Breaker

```cs
public class ExternalApiHealthCheck : IHealthCheck
{
    private readonly IExternalApiService _apiService;
    private readonly ILogger<ExternalApiHealthCheck> _logger;
    
    public ExternalApiHealthCheck(IExternalApiService apiService, ILogger<ExternalApiHealthCheck> logger)
    {
        _apiService = apiService;
        _logger = logger;
    }
    
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ circuit breaker
            if (_apiService is MonitoredCircuitBreakerService monitoredService)
            {
                var circuitBreakerState = GetCircuitBreakerState(monitoredService);
                
                if (circuitBreakerState == CircuitBreakerState.Open)
                {
                    return HealthCheckResult.Unhealthy("Circuit breaker is OPEN");
                }
                
                if (circuitBreakerState == CircuitBreakerState.HalfOpen)
                {
                    return HealthCheckResult.Degraded("Circuit breaker is HALF-OPEN");
                }
            }
            
            // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤
            await _apiService.GetUserAsync(1);
            
            return HealthCheckResult.Healthy("External API is responsive");
        }
        catch (ServiceUnavailableException)
        {
            return HealthCheckResult.Unhealthy("External API is unavailable");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Health check failed");
            return HealthCheckResult.Unhealthy($"Health check failed: {ex.Message}");
        }
    }
    
    private CircuitBreakerState GetCircuitBreakerState(MonitoredCircuitBreakerService service)
    {
        // –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è circuit breaker
        // –ú–æ–∂–Ω–æ —á–µ—Ä–µ–∑ reflection –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        return CircuitBreakerState.Closed;
    }
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Health Check
services.AddHealthChecks()
    .AddCheck<ExternalApiHealthCheck>("external-api");
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω** ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Å–∏—Å—Ç–µ–º:

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–±–æ–∏**
- **–ë—ã—Å—Ç—Ä—ã–µ fallback –æ—Ç–≤–µ—Ç—ã** –≤–º–µ—Å—Ç–æ —Ç–∞–π–º–∞—É—Ç–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –ø–æ—á–∏–Ω–∫–µ —Å–µ—Ä–≤–∏—Å–∞
- **–ó–∞—â–∏—â–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã** –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

### ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- **Failure Threshold** ‚Äî —Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è (–æ–±—ã—á–Ω–æ 3-10)
- **Timeout** ‚Äî –Ω–∞ —Å–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º circuit breaker (30—Å - 5–º–∏–Ω)
- **Fallback Strategy** ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º circuit breaker

### üéØ –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞:

- –í—ã–∑—ã–≤–∞–µ—à—å **–≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã**
- –†–∞–±–æ—Ç–∞–µ—à—å —Å **–±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö**
- –ï—Å—Ç—å —Ä–∏—Å–∫ **–∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤**
- –ù—É–∂–Ω–∞ **–≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** —Å–∏—Å—Ç–µ–º—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π **Polly** –¥–ª—è production –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π ‚Äî —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∏ –º–æ—â–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å –æ—Ç–ª–∏—á–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ .NET —ç–∫–æ—Å–∏—Å—Ç–µ–º—É! üöÄ